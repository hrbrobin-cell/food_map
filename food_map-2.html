<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°ç¾é£Ÿåœ°åœ– (GPSé˜²å‘†ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* --- CSS æ¨£å¼å€ (ç¶­æŒä¸è®Š) --- */
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        .subtitle { color: #7f8c8d; font-size: 0.9em; margin-bottom: 20px; }
        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; max-width: 600px; margin: 0 auto 30px auto;}
        .search-box { flex: 1; padding: 12px; border: 2px solid #ddd; min-width: 200px; border-radius: 30px; font-size: 16px; outline: none; transition: 0.3s; }
        .search-box:focus { border-color: #38b2ac; box-shadow: 0 0 8px rgba(56, 178, 172, 0.3); }
        .btn-pill { padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: 0.3s; border: none; font-size: 0.95em; }
        .btn-fav { background-color: #fff; border: 2px solid #e53e3e; color: #e53e3e; }
        .btn-fav:hover, .btn-fav.active { background-color: #e53e3e; color: white; }
        .btn-gps { background-color: #fff; border: 2px solid #38b2ac; color: #38b2ac; }
        .btn-gps:hover, .btn-gps.active { background-color: #38b2ac; color: white; }
        .btn-gps.loading { opacity: 0.7; cursor: wait; }
        .loading { text-align: center; color: #38b2ac; font-weight: bold; padding: 20px; }
        .error-msg { color: #e53e3e; background: #fff5f5; padding: 15px; border-radius: 10px; border: 1px solid #fc8181; display: inline-block; text-align: left; }
        .filter-section { max-width: 1000px; margin: 0 auto 30px auto; text-align: center; }
        .btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .label { font-size: 14px; color: #888; margin-bottom: 8px; display: block; }
        .btn { border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .city-btn { background-color: #e2e8f0; color: #4a5568; }
        .city-btn:hover, .city-btn.active { background-color: #2d3748; color: white; transform: scale(1.05); }
        .district-btn { background-color: #e6fffa; color: #2c7a7b; border: 1px solid #b2f5ea; }
        .district-btn:hover, .district-btn.active { background-color: #38b2ac; color: white; border-color: #38b2ac; }
        .food-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        .food-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 5px solid #38b2ac; display: flex; flex-direction: column; animation: fadeIn 0.4s; position: relative; }
        .heart-btn { position: absolute; top: 15px; right: 10px; background: none; border: none; font-size: 1.6em; cursor: pointer; color: #ddd; transition: 0.2s; z-index: 10; }
        .heart-btn:hover { transform: scale(1.2); }
        .heart-btn.is-fav { color: #e53e3e; }
        .card-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; padding-right: 35px; }
        .food-card h3 { margin: 5px 0; color: #2c7a7b; font-size: 1.4em; padding-right: 0; }
        .meta-tag { font-size: 12px; color: #fff; background: #38b2ac; padding: 3px 8px; border-radius: 4px; display: inline-block;}
        .dist-badge { font-size: 12px; color: #718096; background: #edf2f7; padding: 2px 6px; border-radius: 4px; margin-left: 5px; display: inline-flex; align-items: center; gap: 3px; }
        .status-badge { font-size: 12px; padding: 2px 8px; border-radius: 12px; font-weight: bold; white-space: nowrap; margin-left: auto; }
        .status-open { background-color: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4; } 
        .status-closed { background-color: #edf2f7; color: #718096; border: 1px solid #cbd5e0; } 
        .info-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.95em; color: #555; }
        .info-icon { margin-right: 8px; width: 20px; text-align: center; }
        .hours-text { color: #e53e3e; font-weight: bold; }
        .note { background: #f8f9fa; color: #666; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.9em; line-height: 1.5; }
        .btn-group { display: flex; gap: 8px; margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; }
        .btn-nav { flex-grow: 1; height: 40px; background-color: #38b2ac; color: white; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-weight: bold; font-size: 0.95em; transition: 0.2s; box-shadow: 0 2px 5px rgba(56, 178, 172, 0.3); }
        .btn-nav:hover { background-color: #319795; transform: translateY(-2px); }
        .btn-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 1.2em; transition: 0.2s; color: white; flex-shrink: 0; }
        .btn-icon:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .bg-web { background-color: #ed8936; } 
        .bg-fb { background-color: #1877F2; }  
        .bg-ig { background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); }
        .bg-yt { background-color: #FF0000; } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ‡¹ğŸ‡¼ å…¨å°ç¾é£Ÿåœ°åœ–</h1>
        <p class="subtitle">å³æ™‚é¡¯ç¤ºç‡Ÿæ¥­ç‹€æ…‹ & è·é›¢</p>
        
        <div class="controls">
            <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹åº—å...">
            <button id="gpsBtn" class="btn-pill btn-gps" onclick="findNearby()">
                <i class="fas fa-location-arrow"></i> é™„è¿‘ç¾é£Ÿ
            </button>
            <button id="favFilterBtn" class="btn-pill btn-fav" onclick="toggleFavFilter()">
                â¤ï¸ å£è¢‹åå–®
            </button>
        </div>
    </header>

    <div id="loading" class="loading">â³ æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</div>
    <div class="filter-section" id="filterSection">
        <span class="label">1. é¸æ“‡ç¸£å¸‚</span>
        <div id="cityButtons" class="btn-container"></div>
        <span class="label">2. é¸æ“‡åœ°å€</span>
        <div id="districtButtons" class="btn-container"></div>
    </div>
    <div class="food-list" id="foodContainer"></div>

    <script>
        window.onerror = function(msg, src, l, c, err) { document.getElementById('loading').innerHTML = `<div class="error-msg">âŒ éŒ¯èª¤ï¼š${msg}</div>`; };
        
        const sheetID = '2PACX-1vRJXAD8XnJT4MfBoaSSCpByuNcUVwlXTCL702vtUBDsg8aZ__v-_yxXVRVQntuqaJY3eecAwq7qZDIb';
        const rawUrl = `https://docs.google.com/spreadsheets/d/e/${sheetID}/pub?output=csv&cache_bust=${Date.now()}`;
        const proxyUrl = 'https://corsproxy.io/?'; 
        const finalUrl = proxyUrl + encodeURIComponent(rawUrl);

        let allData = [];
        let currentCity = "";
        let isShowingFavs = false;
        let isShowingNearby = false;
        let myFavorites = [];
        try { myFavorites = JSON.parse(localStorage.getItem('myFoodFavorites')) || []; } catch (e) {}

        init();

        function init() {
            Papa.parse(finalUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data || results.data.length === 0) return showError("Excel ç„¡è³‡æ–™");
                    processData(results.data);
                },
                error: function() { showError("ç¶²è·¯é€£ç·šå¤±æ•—"); }
            });

            document.getElementById('searchInput').addEventListener('input', (e) => {
                const keyword = e.target.value.toLowerCase();
                resetFilters(); 
                if(keyword) {
                    document.getElementById('filterSection').style.display = 'block';
                    renderFood(allData.filter(item => item.name.toLowerCase().includes(keyword)));
                    document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                } else if(currentCity) filterByCity(currentCity);
            });
        }
        function showError(msg) { document.getElementById('loading').innerHTML = `<div class="error-msg">âš ï¸ ${msg}</div>`; }

        function processData(data) {
            allData = data.filter(item => item.name).map(item => {
                const newItem = {};
                Object.keys(item).forEach(key => {
                    const cleanKey = key ? key.toLowerCase().trim().replace('_', '') : "unknown";
                    newItem[cleanKey] = item[key]?item[key].trim():"";
                });
                if(!newItem.city) newItem.city = "æœªåˆ†é¡";
                newItem.id = `${newItem.city}-${newItem.name || Math.random()}`;
                
                newItem.lat = parseFloat(newItem.lat);
                newItem.lng = parseFloat(newItem.lng);
                newItem.distance = null;

                return newItem;
            });
            document.getElementById('loading').style.display = 'none';
            renderCityButtons();
        }

        /* --- ğŸ“ GPS æ ¸å¿ƒåŠŸèƒ½ (ä¿®å¾©ç‰ˆ) --- */
        function findNearby() {
            if (isShowingNearby) {
                resetFilters();
                if(currentCity) filterByCity(currentCity); else renderCityButtons();
                return;
            }

            const gpsBtn = document.getElementById('gpsBtn');
            gpsBtn.classList.add('loading');
            gpsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å®šä½ä¸­...';

            // 1. æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´
            if (!navigator.geolocation) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                resetGpsBtn();
                return;
            }

            // 2. è¨­å®šé€¾æ™‚ (10ç§’)
            const options = {
                enableHighAccuracy: true,
                timeout: 10000, // 10ç§’é€¾æ™‚
                maximumAge: 0
            };

            // 3. é–‹å§‹å®šä½
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // æˆåŠŸ
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    allData.forEach(item => {
                        if (item.lat && item.lng) {
                            item.distance = calculateDistance(userLat, userLng, item.lat, item.lng);
                        } else {
                            item.distance = 99999;
                        }
                    });

                    const nearbyData = [...allData].sort((a, b) => a.distance - b.distance);
                    isShowingNearby = true;
                    isShowingFavs = false;
                    
                    updateButtonStates();
                    document.getElementById('filterSection').style.display = 'none';
                    renderFood(nearbyData);
                },
                (error) => {
                    // å¤±æ•—æˆ–æ‹’çµ•
                    console.error(error);
                    let errMsg = "å®šä½å¤±æ•—";
                    
                    if (window.location.protocol === 'file:') {
                        errMsg = "âŒ å®šä½åŠŸèƒ½è¢«ç€è¦½å™¨å°é–ï¼\n\nåŸå› ï¼šæ‚¨æ­£åœ¨ç›´æ¥é–‹å•Ÿæª”æ¡ˆ (file://)ã€‚\nç€è¦½å™¨è¦å®šå®šä½åŠŸèƒ½å¿…é ˆåœ¨ç¶²ç«™ä¼ºæœå™¨ä¸Š (https:// æˆ– localhost) æ‰èƒ½ä½¿ç”¨ã€‚\n\nè«‹å˜—è©¦ï¼š\n1. ä¸Šå‚³åˆ° GitHub Pages (æ¨è–¦)\n2. ä½¿ç”¨ VS Code çš„ Live Server";
                    } else if (error.code === error.PERMISSION_DENIED) {
                        errMsg = "æ‚¨æ‹’çµ•äº†å®šä½æ¬Šé™ï¼Œç„¡æ³•å°‹æ‰¾é™„è¿‘åº—å®¶ã€‚";
                    } else if (error.code === error.TIMEOUT) {
                        errMsg = "å®šä½é€¾æ™‚ (è¶…é10ç§’)ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ GPS æ”¶è¨Šæˆ–ç¶²è·¯ã€‚";
                    }

                    alert(errMsg);
                    resetGpsBtn();
                },
                options
            );
        }

        function resetGpsBtn() {
            const gpsBtn = document.getElementById('gpsBtn');
            gpsBtn.classList.remove('loading');
            gpsBtn.innerHTML = '<i class="fas fa-location-arrow"></i> é™„è¿‘ç¾é£Ÿ';
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatDistance(km) { if (km >= 9999) return ""; if (km < 1) return (km * 1000).toFixed(0) + " m"; return km.toFixed(1) + " km"; }
        function resetFilters() { isShowingFavs = false; isShowingNearby = false; updateButtonStates(); document.getElementById('filterSection').style.display = 'block'; }
        function updateButtonStates() {
            const favBtn = document.getElementById('favFilterBtn'); const gpsBtn = document.getElementById('gpsBtn');
            if (isShowingFavs) { favBtn.classList.add('active'); favBtn.innerText = "ğŸ”™ å›åˆ°åˆ—è¡¨"; } else { favBtn.classList.remove('active'); favBtn.innerText = "â¤ï¸ å£è¢‹åå–®"; }
            if (isShowingNearby) { gpsBtn.classList.add('active'); gpsBtn.innerHTML = '<i class="fas fa-times"></i> æ¸…é™¤å®šä½'; } else { gpsBtn.classList.remove('active'); gpsBtn.classList.remove('loading'); gpsBtn.innerHTML = '<i class="fas fa-location-arrow"></i> é™„è¿‘ç¾é£Ÿ'; }
        }

        /* --- å…¶ä»–åŠŸèƒ½ --- */
        function checkIsOpen(hoursStr) {
            if (!hoursStr) return false;
            let cleanStr = hoursStr.replace(/ï¼š/g, ":").replace(/ï½/g, "-").replace(/~/g, "-").replace(/&/g, ",");
            cleanStr = cleanStr.replace(/\b(\d{4})\b/g, (match) => { return match.slice(0, 2) + ":" + match.slice(2); });
            cleanStr = cleanStr.replace(/\b(\d{3})\b/g, (match) => { return "0" + match.slice(0, 1) + ":" + match.slice(1); });

            const now = new Date();
            const dayOfWeek = now.getDay(); 
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const dayMap = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            const todayStr = dayMap[dayOfWeek];
            if (hoursStr.includes(todayStr + "å…¬ä¼‘") || hoursStr.includes(todayStr + "ä¼‘æ¯")) return false;
            if (hoursStr.toUpperCase().includes('24H') || hoursStr.includes('24å°æ™‚')) return true;
            const timeMatches = cleanStr.match(/(\d{1,2}:\d{2})/g);
            if (!timeMatches || timeMatches.length < 2) return null;
            let isOpen = false;
            for (let i = 0; i < timeMatches.length; i += 2) {
                if (i + 1 >= timeMatches.length) break;
                const start = parseTime(timeMatches[i]);
                const end = parseTime(timeMatches[i+1]);
                if (end < start) { if (currentMinutes >= start || currentMinutes <= end) isOpen = true; } 
                else { if (currentMinutes >= start && currentMinutes <= end) isOpen = true; }
            }
            return isOpen;
        }
        function parseTime(t) { const parts = t.split(':'); return parseInt(parts[0]) * 60 + parseInt(parts[1]); }
        function formatPhoneNumber(p) { if (!p) return "ç„¡"; let c = p.replace(/\D/g, ''); if (c.length === 10 && c.startsWith('09')) return c.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3'); if (c.length === 10 && c.startsWith('0')) return c.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3'); return p; }
        
        function renderCityButtons() {
            const cities = [...new Set(allData.map(item => item.city))];
            const container = document.getElementById('cityButtons'); container.innerHTML = '';
            cities.forEach(city => { const btn = document.createElement('button'); btn.className = 'btn city-btn'; btn.innerText = city; btn.onclick = () => filterByCity(city, btn); container.appendChild(btn); });
            if(cities.length>0) filterByCity(cities[0], container.firstChild);
        }
        function filterByCity(city, btn) {
            currentCity = city;
            if(btn) { document.querySelectorAll('.city-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            const cityData = allData.filter(i => i.city === city);
            const districts = ["å…¨éƒ¨", ...new Set(cityData.map(i => i.district))];
            const dc = document.getElementById('districtButtons'); dc.innerHTML = '';
            districts.forEach(d => { const b = document.createElement('button'); b.className = 'btn district-btn'; b.innerText = d; b.onclick = (e) => filterByDistrict(city, d, e.target); dc.appendChild(b); });
            filterByDistrict(city, "å…¨éƒ¨", dc.firstChild);
        }
        function filterByDistrict(city, district, btn) {
            document.querySelectorAll('.district-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active');
            let res = (district === "å…¨éƒ¨") ? allData.filter(i => i.city === city) : allData.filter(i => i.city === city && i.district === district);
            renderFood(res);
        }

        function renderFood(data) {
            const container = document.getElementById('foodContainer'); container.innerHTML = '';
            if(data.length === 0) return container.innerHTML = '<p style="text-align:center;width:100%;color:#888;">ç„¡ç›¸é—œåº—å®¶</p>';

            data.forEach(item => {
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address||item.name)}`;
                const displayPhone = formatPhoneNumber(item.phone);
                const rawPhone = item.phone ? item.phone.replace(/\D/g, '') : "";
                
                const linkWeb = item.website || (item.link && !item.linkname ? item.link : ""); 
                const linkFB  = item.fb; const linkIG  = item.ig; const linkYT  = item.youtube;
                
                let buttonsHtml = `<a href="${mapLink}" target="_blank" class="btn-nav"><i class="fas fa-map-marker-alt" style="margin-right:5px;"></i> å°èˆª</a>`;
                if (linkWeb) buttonsHtml += `<a href="${linkWeb}" target="_blank" class="btn-icon bg-web" title="å®˜æ–¹ç¶²ç«™"><i class="fas fa-globe"></i></a>`;
                if (linkFB) buttonsHtml += `<a href="${linkFB}" target="_blank" class="btn-icon bg-fb" title="Facebook"><i class="fab fa-facebook-f"></i></a>`;
                if (linkIG) buttonsHtml += `<a href="${linkIG}" target="_blank" class="btn-icon bg-ig" title="Instagram"><i class="fab fa-instagram"></i></a>`;
                if (linkYT) buttonsHtml += `<a href="${linkYT}" target="_blank" class="btn-icon bg-yt" title="YouTube"><i class="fab fa-youtube"></i></a>`;

                const isOpen = checkIsOpen(item.hours);
                let statusBadge = '';
                if (isOpen === true) statusBadge = '<span class="status-badge status-open">ğŸŸ¢ ç‡Ÿæ¥­ä¸­</span>';
                else if (isOpen === false) statusBadge = '<span class="status-badge status-closed">âšª ä¼‘æ¯ä¸­</span>';

                let distHtml = '';
                if (isShowingNearby && item.distance && item.distance < 9000) {
                    distHtml = `<span class="dist-badge"><i class="fas fa-route"></i> ${formatDistance(item.distance)}</span>`;
                }

                const isFav = myFavorites.includes(item.id);
                const card = document.createElement('div');
                card.className = 'food-card';
                card.innerHTML = `
                    <button class="${isFav?'heart-btn is-fav':'heart-btn'}" onclick="toggleHeart('${item.id}', this)">â¤</button>
                    <div class="card-top-row">
                        <div class="meta-tag">${item.city} ${item.district} | ${item.type}</div>
                        ${statusBadge}
                    </div>
                    <h3>${item.name} ${distHtml}</h3>
                    <div class="info-row"><span class="info-icon">â°</span><span class="hours-text">${item.hours}</span></div>
                    <div class="info-row"><span class="info-icon">ğŸ“</span><a href="tel:${rawPhone}" style="color:#333;text-decoration:none">${displayPhone}</a></div>
                    <div class="info-row"><span class="info-icon">ğŸ </span><span>${item.address}</span></div>
                    <p class="note">${item.note}</p>
                    <div class="btn-group">${buttonsHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        function toggleFavFilter() {
            isShowingFavs = !isShowingFavs; isShowingNearby = false; updateButtonStates();
            const fs = document.getElementById('filterSection');
            if(isShowingFavs) {
                fs.style.display = 'none';
                const favs = allData.filter(i => myFavorites.includes(i.id));
                renderFood(favs);
                if(favs.length===0) document.getElementById('foodContainer').innerHTML = '<div style="text-align:center;padding:50px;color:#888;">å°šç„¡æœ€æ„›</div>';
            } else { resetFilters(); if(currentCity) filterByCity(currentCity); }
        }
        function toggleHeart(id, btn) {
            const idx = myFavorites.indexOf(id);
            if(idx===-1) { myFavorites.push(id); btn.classList.add('is-fav'); }
            else { myFavorites.splice(idx,1); btn.classList.remove('is-fav'); if(isShowingFavs) toggleFavFilter(); }
            localStorage.setItem('myFoodFavorites', JSON.stringify(myFavorites));
        }
    </script>
</body>
</html>