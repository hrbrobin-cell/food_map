<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°ç¾é£Ÿåœ°åœ– (å°ˆæ¥­è¦–è¦ºç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* --- CSS æ¨£å¼å€ --- */
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        .subtitle { color: #7f8c8d; font-size: 0.9em; margin-bottom: 20px; }
        
        /* æ§åˆ¶å€å¡Š (RWDå„ªåŒ–) */
        .controls-wrapper { max-width: 900px; margin: 0 auto 30px auto; }
        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 10px; }
        
        .search-box { flex: 2; padding: 12px; border: 2px solid #ddd; min-width: 200px; border-radius: 30px; font-size: 16px; outline: none; transition: 0.3s; }
        .search-box:focus { border-color: #38b2ac; box-shadow: 0 0 8px rgba(56, 178, 172, 0.3); }

        /* ä¸‹æ‹‰é¸å–®å…±ç”¨æ¨£å¼ */
        .select-pill {
            flex: 1; min-width: 130px; padding: 0 15px; border: 2px solid #ddd; border-radius: 30px; height: 46px;
            font-size: 15px; outline: none; background: white; cursor: pointer; color: #555;
            appearance: none; /* éš±è—é è¨­ç®­é ­ï¼Œæ”¹ç”¨è‡ªå®šç¾© */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 10px auto;
        }
        .select-pill:focus { border-color: #38b2ac; }

        /* æŒ‰éˆ•å…±ç”¨ */
        .btn-pill { padding: 0 20px; height: 46px; border-radius: 30px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.3s; border: none; font-size: 0.95em; white-space: nowrap; min-width: 100px; }
        .btn-fav { background-color: #fff; border: 2px solid #e53e3e; color: #e53e3e; }
        .btn-fav:hover, .btn-fav.active { background-color: #e53e3e; color: white; }
        .btn-gps { background-color: #fff; border: 2px solid #38b2ac; color: #38b2ac; }
        .btn-gps:hover, .btn-gps.active { background-color: #38b2ac; color: white; }
        .btn-gps.loading { opacity: 0.7; cursor: wait; pointer-events: none; }

        .loading { text-align: center; color: #38b2ac; font-weight: bold; padding: 20px; }
        .error-msg { color: #e53e3e; background: #fff5f5; padding: 15px; border-radius: 10px; border: 1px solid #fc8181; display: inline-block; text-align: left; }

        .filter-section { max-width: 1000px; margin: 0 auto 30px auto; text-align: center; }
        .btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .label { font-size: 14px; color: #888; margin-bottom: 8px; display: block; }
        .btn { border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .city-btn { background-color: #e2e8f0; color: #4a5568; }
        .city-btn.active { background-color: #2d3748; color: white; transform: scale(1.05); }
        .district-btn { background-color: #e6fffa; color: #2c7a7b; border: 1px solid #b2f5ea; }
        .district-btn.active { background-color: #38b2ac; color: white; border-color: #38b2ac; }

        /* å¡ç‰‡åˆ—è¡¨ */
        .food-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; max-width: 1200px; margin: 0 auto; }
        /* âœ¨ å¡ç‰‡æ¨£å¼é‡æ§‹ï¼šç§»é™¤ paddingï¼Œæ”¹ç”¨å…§éƒ¨å®¹å™¨ */
        .food-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; animation: fadeIn 0.4s; position: relative; }
        
        /* âœ¨ æ–°å¢ï¼šåœ–ç‰‡å®¹å™¨ */
        .card-image {
            width: 100%; height: 180px; background-color: #eee; position: relative; overflow: hidden;
        }
        .card-image img {
            width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;
        }
        .food-card:hover .card-image img { transform: scale(1.05); } /* æ»‘é¼ æ‡¸åœç‰¹æ•ˆ */

        /* âœ¨ æ–°å¢ï¼šå¡ç‰‡å…§å®¹å®¹å™¨ (è² è²¬ padding) */
        .card-content { padding: 15px 20px 20px 20px; display: flex; flex-direction: column; flex-grow: 1; }

        .heart-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.3); border-radius: 50%; width: 36px; height: 36px; border: none; font-size: 1.5em; cursor: pointer; color: rgba(255,255,255,0.8); transition: 0.2s; z-index: 10; display: flex; align-items: center; justify-content: center; padding-top: 4px;}
        .heart-btn:hover { transform: scale(1.1); background: rgba(0,0,0,0.5); color: white; }
        .heart-btn.is-fav { color: #e53e3e; background: white; }

        .card-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 5px; }
        .meta-group { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .meta-tag { font-size: 12px; color: #555; background: #eee; padding: 3px 8px; border-radius: 4px; display: inline-block;}
        
        .card-title {
            margin: 5px 0 12px 0; color: #2c3e50; font-size: 1.35em;
            display: flex; align-items: center; flex-wrap: wrap; gap: 8px; line-height: 1.3;
        }

        /* è©•åˆ†èˆ‡è·é›¢å¾½ç«  */
        .rating-badge { font-size: 13px; color: #b7791f; background: #fffbe6; border: 1px solid #f6e05e; padding: 2px 8px; border-radius: 12px; font-weight: bold; display: inline-flex; align-items: center; gap: 3px; vertical-align: middle; }
        .dist-badge { font-size: 13px; color: #4a5568; background: #edf2f7; padding: 2px 8px; border-radius: 12px; display: inline-flex; align-items: center; gap: 3px; vertical-align: middle; }
        
        .status-badge { font-size: 12px; padding: 2px 8px; border-radius: 12px; font-weight: bold; white-space: nowrap; margin-left: auto; }
        .status-open { background-color: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4; } 
        .status-closed { background-color: #edf2f7; color: #718096; border: 1px solid #cbd5e0; } 

        /* è³‡è¨Šè¡Œ */
        .info-row { display: flex; align-items: flex-start; margin-bottom: 8px; font-size: 0.95em; color: #555; line-height: 1.4; }
        .info-icon { margin-right: 10px; width: 16px; text-align: center; color: #38b2ac; margin-top: 2px; }
        .hours-text { color: #e53e3e; font-weight: bold; }
        .note { background: #f8f9fa; color: #666; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.9em; line-height: 1.5; }
        
        .btn-group { display: flex; gap: 8px; margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; }
        .btn-nav { flex-grow: 1; height: 40px; background-color: #38b2ac; color: white; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-weight: bold; font-size: 0.95em; transition: 0.2s; box-shadow: 0 2px 5px rgba(56, 178, 172, 0.3); }
        .btn-nav:hover { background-color: #319795; transform: translateY(-2px); }
        .btn-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 1.2em; transition: 0.2s; color: white; border: 1px solid #eee; flex-shrink: 0; }
        .btn-icon:hover { transform: translateY(-2px); filter: brightness(0.95); }
        
        .bg-web { color: #ed8936; } 
        .bg-fb { color: #1877F2; }  
        .bg-ig { color: #d6249f; }
        .bg-yt { color: #FF0000; } 
        
        #debugLog { margin-top: 50px; padding: 15px; background: #2d3748; color: #00ff00; font-family: monospace; border-radius: 8px; font-size: 12px; max-height: 200px; overflow-y: auto; display: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ‡¹ğŸ‡¼ å…¨å°ç¾é£Ÿåœ°åœ–</h1>
        <p class="subtitle">å°ˆæ¥­è¦–è¦ºç‰ˆ (åœ–ç‰‡å±•ç¤º + æ™ºæ…§æ’åº)</p>
        
        <div class="controls-wrapper">
            <div class="controls">
                <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹åº—å...">
                
                <select id="rangeSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="99999">ğŸ“ è·é›¢: å…¨éƒ¨</option>
                    <option value="1">1 å…¬é‡Œå…§</option>
                    <option value="3">3 å…¬é‡Œå…§</option>
                    <option value="5" selected>5 å…¬é‡Œå…§</option>
                    <option value="10">10 å…¬é‡Œå…§</option>
                </select>

                <select id="sortSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="dist" selected>ğŸ“ è·é›¢è¿‘â†’é </option>
                    <option value="rating">â­ è©•åˆ†é«˜â†’ä½</option>
                </select>
            </div>
            <div class="controls">
                <button id="gpsBtn" class="btn-pill btn-gps" onclick="findNearby()">
                    <i class="fas fa-location-arrow"></i> é™„è¿‘ç¾é£Ÿ
                </button>
                <button id="favFilterBtn" class="btn-pill btn-fav" onclick="toggleFavFilter()">
                    â¤ï¸ å£è¢‹åå–®
                </button>
            </div>
        </div>
    </header>

    <div id="loading" class="loading">â³ æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</div>
    
    <div class="filter-section" id="filterSection">
        <span class="label">1. é¸æ“‡ç¸£å¸‚</span>
        <div id="cityButtons" class="btn-container"></div>
        <span class="label">2. é¸æ“‡åœ°å€</span>
        <div id="districtButtons" class="btn-container"></div>
    </div>
    
    <div class="food-list" id="foodContainer"></div>
    
    <div id="debugLog"><strong>System Log:</strong><br></div>

    <script>
        // --- 1. ç³»çµ±æ ¸å¿ƒ ---
        function log(msg) {
            console.log(msg);
            const debugDiv = document.getElementById('debugLog');
            if(debugDiv.style.display !== 'block') debugDiv.style.display = 'block';
            debugDiv.innerHTML += `> ${msg}<br>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        window.onerror = function(msg, src, l, c, err) { 
            document.getElementById('loading').innerHTML = `<div class="error-msg">âŒ ç¨‹å¼éŒ¯èª¤ï¼š${msg}</div>`; 
            log(`âŒ ERROR: ${msg} (Line ${l})`);
        };
        
        const sheetID = '2PACX-1vRJXAD8XnJT4MfBoaSSCpByuNcUVwlXTCL702vtUBDsg8aZ__v-_yxXVRVQntuqaJY3eecAwq7qZDIb';
        const rawUrl = `https://docs.google.com/spreadsheets/d/e/${sheetID}/pub?output=csv&cache_bust=${Date.now()}`;
        const proxyList = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url=', 'https://api.codetabs.com/v1/proxy?quest='];

        // --- ç‹€æ…‹è®Šæ•¸ (çµ±ä¸€ç®¡ç†) ---
        let appState = {
            allData: [],
            currentCity: "",
            currentDistrict: "å…¨éƒ¨",
            currentKeyword: "",
            isShowingFavs: false,
            isShowingNearby: false,
            myFavorites: []
        };

        // é è¨­åœ–ç‰‡ (ç•¶ Excel æ²’å¡«åœ–ç‰‡æ™‚é¡¯ç¤º)
        const PLACEHOLDER_IMAGE = "https://placehold.co/600x400/eee/999?text=ç¾é£Ÿç…§ç‰‡&font=noto-sans-tc";

        try { appState.myFavorites = JSON.parse(localStorage.getItem('myFoodFavorites')) || []; } catch (e) {}

        init();

        function init() {
            log("ğŸš€ ç³»çµ±å•Ÿå‹•...");
            tryFetchData(0);

            // ç¶å®šæœå°‹äº‹ä»¶
            document.getElementById('searchInput').addEventListener('input', (e) => {
                appState.currentKeyword = e.target.value.toLowerCase();
                appState.isShowingFavs = false;
                updateUIState();
                applyFiltersAndSort();
            });
        }

        // --- è³‡æ–™è®€å–èˆ‡è™•ç† ---
        function tryFetchData(proxyIndex) {
            if (proxyIndex >= proxyList.length) return showError("ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«");
            const finalUrl = proxyList[proxyIndex] + encodeURIComponent(rawUrl);
            log(`ğŸ“¡ é€£ç·šä¸­ (ç·šè·¯ ${proxyIndex + 1})...`);
            Papa.parse(finalUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data || results.data.length === 0) return tryFetchData(proxyIndex + 1);
                    log(`âœ… é€£ç·šæˆåŠŸ (ç·šè·¯ ${proxyIndex + 1})`);
                    processData(results.data);
                },
                error: () => tryFetchData(proxyIndex + 1)
            });
        }

        function showError(msg) { document.getElementById('loading').innerHTML = `<div class="error-msg">âš ï¸ ${msg}</div>`; }

        function processData(data) {
            try {
                appState.allData = data.filter(item => item.name).map(item => {
                    const newItem = {};
                    Object.keys(item).forEach(key => {
                        const cleanKey = key ? key.toLowerCase().trim().replace('_', '') : "unknown";
                        newItem[cleanKey] = item[key]?item[key].trim():"";
                    });
                    if(!newItem.city) newItem.city = "æœªåˆ†é¡";
                    newItem.id = `${newItem.city}-${newItem.name || Math.random()}`;
                    newItem.lat = parseFloat(newItem.lat);
                    newItem.lng = parseFloat(newItem.lng);
                    if (isNaN(newItem.lat) || isNaN(newItem.lng)) { newItem.lat = null; newItem.lng = null; }
                    
                    // è®€å–è©•åˆ†èˆ‡åœ–ç‰‡
                    newItem.rating = parseFloat(newItem.rating || newItem.googlerating || 0);
                    newItem.image = newItem.image || PLACEHOLDER_IMAGE; // âœ¨ è¨­å®šåœ–ç‰‡

                    newItem.distance = null;
                    return newItem;
                });
                document.getElementById('loading').style.display = 'none';
                renderCityButtons();
            } catch(e) {
                log("âŒ è³‡æ–™è™•ç†éŒ¯èª¤ï¼š" + e.message);
            }
        }

        /* --- æ ¸å¿ƒåŠŸèƒ½ï¼šGPS å®šä½ --- */
        function findNearby() {
            if (appState.isShowingNearby) {
                // å¦‚æœå·²ç¶“åœ¨é™„è¿‘æ¨¡å¼ï¼Œå†é»ä¸€æ¬¡å°±å–æ¶ˆ
                resetToDefaultView();
                return;
            }

            const gpsBtn = document.getElementById('gpsBtn');
            gpsBtn.classList.add('loading');
            gpsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å®šä½ä¸­...';

            // ç’°å¢ƒæª¢æŸ¥
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                 setTimeout(() => useFakeGPS("ç’°å¢ƒé™åˆ¶"), 500); return;
            }
            if (!navigator.geolocation) { useFakeGPS("ç€è¦½å™¨ä¸æ”¯æ´"); return; }

            // 10ç§’é€¾æ™‚
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    log("âœ… å®šä½æˆåŠŸ");
                    calculateDistances(position.coords.latitude, position.coords.longitude);
                },
                (error) => {
                    log(`âš ï¸ å®šä½å¤±æ•—ï¼Œåˆ‡æ›æ¨¡æ“¬`);
                    useFakeGPS("å®šä½é€¾æ™‚æˆ–å¤±æ•—");
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function useFakeGPS(reason) {
            log(`å·²åˆ‡æ›æ¨¡æ“¬ä½ç½® (${reason})`);
            calculateDistances(25.0478, 121.5170); // å°åŒ—è»Šç«™
        }

        // è¨ˆç®—è·é›¢ä¸¦åˆ‡æ›ç‹€æ…‹
        function calculateDistances(userLat, userLng) {
            appState.allData.forEach(item => {
                if (item.lat && item.lng) {
                    item.distance = calculateDistance(userLat, userLng, item.lat, item.lng);
                } else {
                    item.distance = 99999;
                }
            });
            
            // åˆ‡æ›ç‚ºé™„è¿‘æ¨¡å¼
            appState.isShowingNearby = true;
            appState.isShowingFavs = false;
            // é™„è¿‘æ¨¡å¼é è¨­ç”¨è·é›¢æ’åº
            document.getElementById('sortSelect').value = 'dist'; 

            updateUIState();
            applyFiltersAndSort();
        }

        /* --- æ ¸å¿ƒåŠŸèƒ½ï¼šç¯©é¸èˆ‡æ’åºå¼•æ“ (é‡æ§‹ç‰ˆ) --- */
        function applyFiltersAndSort() {
            let results = [...appState.allData]; // è¤‡è£½ä¸€ä»½è³‡æ–™

            // 1. æ¨¡å¼ç¯©é¸ (å£è¢‹åå–® vs ä¸€èˆ¬æœå°‹)
            if (appState.isShowingFavs) {
                results = results.filter(i => appState.myFavorites.includes(i.id));
            } else {
                // é—œéµå­—å„ªå…ˆ
                if (appState.currentKeyword) {
                    results = results.filter(item => item.name.toLowerCase().includes(appState.currentKeyword));
                } 
                // å¦å‰‡ç”¨ç¸£å¸‚åœ°å€
                else if (appState.currentCity) {
                    results = results.filter(i => i.city === appState.currentCity);
                    if (appState.currentDistrict !== "å…¨éƒ¨") {
                        results = results.filter(i => i.district === appState.currentDistrict);
                    }
                }
            }

            // 2. è·é›¢ç¯©é¸ (åªåœ¨é™„è¿‘æ¨¡å¼ç”Ÿæ•ˆ)
            if (appState.isShowingNearby) {
                const limit = parseFloat(document.getElementById('rangeSelect').value);
                results = results.filter(item => item.distance <= limit);
            }

            // 3. âœ¨ æ™ºæ…§æ’åº
            const sortMode = document.getElementById('sortSelect').value;
            results.sort((a, b) => {
                if (sortMode === 'rating') {
                    // è©•åˆ†é«˜ -> ä½ (æ²’æœ‰è©•åˆ†çš„æ’å¾Œé¢)
                    return (b.rating || -1) - (a.rating || -1);
                } else {
                    // è·é›¢è¿‘ -> é  (é è¨­)
                    return (a.distance || 99999) - (b.distance || 99999);
                }
            });

            renderFood(results);
        }

        // å›åˆ°é è¨­è¦–åœ–
        function resetToDefaultView() {
            appState.isShowingNearby = false;
            appState.isShowingFavs = false;
            appState.currentKeyword = "";
            document.getElementById('searchInput').value = "";
            updateUIState();
            // å¦‚æœæœ‰é¸éç¸£å¸‚å°±å›åˆ°ç¸£å¸‚ï¼Œæ²’æœ‰å°±é¡¯ç¤ºå…¨éƒ¨æŒ‰éˆ•
            if (appState.currentCity) filterByCity(appState.currentCity); else renderCityButtons();
        }

        /* --- UI æ›´æ–°èˆ‡æ¸²æŸ“ --- */
        function updateUIState() {
            const favBtn = document.getElementById('favFilterBtn');
            const gpsBtn = document.getElementById('gpsBtn');
            const filterSection = document.getElementById('filterSection');

            gpsBtn.classList.remove('loading'); // ç§»é™¤ loading

            // æ›´æ–°å£è¢‹åå–®æŒ‰éˆ•
            if (appState.isShowingFavs) {
                favBtn.classList.add('active'); favBtn.innerText = "ğŸ”™ å›åˆ—è¡¨";
            } else {
                favBtn.classList.remove('active'); favBtn.innerText = "â¤ï¸ å£è¢‹";
            }

            // æ›´æ–°å®šä½æŒ‰éˆ•èˆ‡ç¯©é¸å€é¡¯ç¤º
            if (appState.isShowingNearby) {
                gpsBtn.classList.add('active'); gpsBtn.innerHTML = '<i class="fas fa-times"></i> æ¸…é™¤å®šä½';
                filterSection.style.display = 'none'; // é™„è¿‘æ¨¡å¼éš±è—åœ°å€æŒ‰éˆ•
            } else {
                gpsBtn.classList.remove('active'); gpsBtn.innerHTML = '<i class="fas fa-location-arrow"></i> é™„è¿‘ç¾é£Ÿ';
                // åªæœ‰åœ¨éé—œéµå­—æœå°‹ä¸”éå£è¢‹æ¨¡å¼æ™‚é¡¯ç¤ºåœ°å€æŒ‰éˆ•
                filterSection.style.display = (appState.currentKeyword || appState.isShowingFavs) ? 'none' : 'block';
            }
        }

        // æ¸²æŸ“åˆ—è¡¨ (å«åœ–ç‰‡çµæ§‹)
        function renderFood(data) {
            const container = document.getElementById('foodContainer'); container.innerHTML = '';
            if(data.length === 0) return container.innerHTML = '<p style="text-align:center;width:100%;color:#888;padding:40px;grid-column:1/-1;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„åº—å®¶</p>';

            data.forEach(item => {
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address||item.name)}`;
                const displayPhone = formatPhoneNumber(item.phone);
                const rawPhone = item.phone ? item.phone.replace(/\D/g, '') : "";
                
                const linkWeb = item.website || (item.link && !item.linkname ? item.link : ""); 
                const linkFB  = item.fb; const linkIG  = item.ig; const linkYT  = item.youtube;
                
                let buttonsHtml = `<a href="${mapLink}" target="_blank" class="btn-nav"><i class="fas fa-map-marker-alt" style="margin-right:5px;"></i> å°èˆª</a>`;
                if (linkWeb) buttonsHtml += `<a href="${linkWeb}" target="_blank" class="btn-icon bg-web" title="å®˜æ–¹ç¶²ç«™"><i class="fas fa-globe"></i></a>`;
                if (linkFB) buttonsHtml += `<a href="${linkFB}" target="_blank" class="btn-icon bg-fb" title="Facebook"><i class="fab fa-facebook-f"></i></a>`;
                if (linkIG) buttonsHtml += `<a href="${linkIG}" target="_blank" class="btn-icon bg-ig" title="Instagram"><i class="fab fa-instagram"></i></a>`;
                if (linkYT) buttonsHtml += `<a href="${linkYT}" target="_blank" class="btn-icon bg-yt" title="YouTube"><i class="fab fa-youtube"></i></a>`;

                const isOpen = checkIsOpen(item.hours);
                let statusBadge = isOpen === true ? '<span class="status-badge status-open">ğŸŸ¢ ç‡Ÿæ¥­ä¸­</span>' : (isOpen === false ? '<span class="status-badge status-closed">âšª ä¼‘æ¯ä¸­</span>' : '');
                
                let ratingHtml = item.rating > 0 ? `<span class="rating-badge"><i class="fas fa-star"></i> ${item.rating.toFixed(1)}</span>` : '';
                let distHtml = (appState.isShowingNearby && item.distance < 9000) ? `<span class="dist-badge"><i class="fas fa-route"></i> ${formatDistance(item.distance)}</span>` : '';

                const isFav = appState.myFavorites.includes(item.id);
                const card = document.createElement('div');
                card.className = 'food-card';
                
                // âœ¨ æ–°å¢ï¼šåœ–ç‰‡å€å¡Š + å…§å®¹å®¹å™¨å€å¡Š
                card.innerHTML = `
                    <div class="card-image">
                        <img src="${item.image}" alt="${item.name}" loading="lazy">
                        <button class="${isFav?'heart-btn is-fav':'heart-btn'}" onclick="toggleHeart('${item.id}', this)">â¤</button>
                    </div>
                    <div class="card-content">
                        <div class="card-top-row">
                            <div class="meta-group">
                                <span class="meta-tag">${item.city} ${item.district}</span>
                                <span class="meta-tag">${item.type}</span>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <h3 class="card-title">
                            <span>${item.name}</span>
                            ${ratingHtml}
                            ${distHtml}
                        </h3>

                        <div class="info-row"><i class="far fa-clock info-icon"></i><span class="hours-text">${item.hours}</span></div>
                        <div class="info-row"><i class="fas fa-phone-alt info-icon"></i><a href="tel:${rawPhone}" style="color:#333;text-decoration:none">${displayPhone}</a></div>
                        <div class="info-row"><i class="fas fa-map-marker-alt info-icon"></i><span>${item.address}</span></div>
                        ${item.note ? `<p class="note">${item.note}</p>` : ''}
                        <div class="btn-group">${buttonsHtml}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- åœ°å€æŒ‰éˆ•é‚è¼¯ ---
        function renderCityButtons() {
            const cities = [...new Set(appState.allData.map(item => item.city))];
            const container = document.getElementById('cityButtons'); container.innerHTML = '';
            cities.forEach(city => { 
                const btn = document.createElement('button'); btn.className = 'btn city-btn'; btn.innerText = city; 
                btn.onclick = () => { appState.currentCity = city; appState.currentDistrict = "å…¨éƒ¨"; appState.currentKeyword = ""; document.getElementById('searchInput').value=""; filterByCity(btn); }; 
                container.appendChild(btn); 
            });
            if(cities.length>0 && !appState.currentCity) { appState.currentCity = cities[0]; filterByCity(container.firstChild); }
        }
        function filterByCity(btn) {
            document.querySelectorAll('.city-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active');
            const cityData = appState.allData.filter(i => i.city === appState.currentCity);
            const districts = ["å…¨éƒ¨", ...new Set(cityData.map(i => i.district))];
            const dc = document.getElementById('districtButtons'); dc.innerHTML = '';
            districts.forEach(d => { 
                const btn = document.createElement('button'); btn.className = 'btn district-btn'; btn.innerText = d; 
                if(d === appState.currentDistrict) btn.classList.add('active');
                btn.onclick = () => { appState.currentDistrict = d; document.querySelectorAll('.district-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); applyFiltersAndSort(); }; 
                dc.appendChild(btn); 
            });
            applyFiltersAndSort();
        }

        // --- å£è¢‹åå–®é‚è¼¯ ---
        function toggleFavFilter() {
            appState.isShowingFavs = !appState.isShowingFavs;
            appState.isShowingNearby = false; // åˆ‡æ›å£è¢‹æ™‚é—œé–‰é™„è¿‘æ¨¡å¼
            updateUIState();
            applyFiltersAndSort();
        }
        function toggleHeart(id, btn) {
            const idx = appState.myFavorites.indexOf(id);
            if(idx===-1) { appState.myFavorites.push(id); btn.classList.add('is-fav'); }
            else { appState.myFavorites.splice(idx,1); btn.classList.remove('is-fav'); if(appState.isShowingFavs) applyFiltersAndSort(); }
            localStorage.setItem('myFoodFavorites', JSON.stringify(appState.myFavorites));
        }

        // --- å·¥å…·å‡½å¼ ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }
        function formatDistance(km) { if (km >= 9999) return ""; if (km < 1) return (km * 1000).toFixed(0) + " m"; return km.toFixed(1) + " km"; }
        function parseTime(t) { const parts = t.split(':'); return parseInt(parts[0]) * 60 + parseInt(parts[1]); }
        function formatPhoneNumber(p) { if (!p) return "ç„¡"; let c = p.replace(/\D/g, ''); if (c.length === 10 && c.startsWith('09')) return c.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3'); if (c.length === 10 && c.startsWith('0')) return c.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3'); return p; }
        function checkIsOpen(hoursStr) {
            if (!hoursStr) return false;
            let cleanStr = hoursStr.replace(/ï¼š/g, ":").replace(/ï½/g, "-").replace(/~/g, "-").replace(/&/g, ",");
            cleanStr = cleanStr.replace(/\b(\d{4})\b/g, (match) => { return match.slice(0, 2) + ":" + match.slice(2); });
            cleanStr = cleanStr.replace(/\b(\d{3})\b/g, (match) => { return "0" + match.slice(0, 1) + ":" + match.slice(1); });
            const now = new Date(); const dayOfWeek = now.getDay(); const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const dayMap = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            if (hoursStr.includes(dayMap[dayOfWeek] + "å…¬ä¼‘") || hoursStr.includes(dayMap[dayOfWeek] + "ä¼‘æ¯")) return false;
            if (hoursStr.toUpperCase().includes('24H') || hoursStr.includes('24å°æ™‚')) return true;
            const timeMatches = cleanStr.match(/(\d{1,2}:\d{2})/g); if (!timeMatches || timeMatches.length < 2) return null;
            let isOpen = false;
            for (let i = 0; i < timeMatches.length; i += 2) {
                const start = parseTime(timeMatches[i]); const end = parseTime(timeMatches[i+1]);
                if (end < start) { if (currentMinutes >= start || currentMinutes <= end) isOpen = true; } 
                else { if (currentMinutes >= start && currentMinutes <= end) isOpen = true; }
            }
            return isOpen;
        }
    </script>
</body>
</html>
