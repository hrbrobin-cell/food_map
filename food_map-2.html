<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°ç¾é£Ÿåœ°åœ– (v29.0 æ——è‰¦ä»‹é¢ç‰ˆ)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        :root {
            --primary: #38b2ac;
            --primary-dark: #319795;
            --accent: #ed8936;
            --michelin-red: #bd2333;
            --text-main: #2d3748;
            --bg-gray: #f7fafc;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: var(--bg-gray); 
            margin: 0; 
            padding: 0; /* ç§»é™¤ paddingï¼Œç”± header æ§åˆ¶ */
            color: var(--text-main); 
            -webkit-tap-highlight-color: transparent;
        }

        /* --- é ‚éƒ¨å¸é ‚å€ (Sticky Header) --- */
        header { 
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 15px 15px 5px 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            transition: 0.3s;
        }

        h1 { 
            color: #2c3e50; 
            margin: 0 0 5px 0; 
            font-size: 1.8em; 
            font-weight: 900; 
            letter-spacing: 1px;
            text-align: center;
        }
        
        .subtitle { 
            color: #718096; 
            font-size: 0.95em; 
            margin-bottom: 15px; 
            text-align: center;
            font-weight: 500;
        }

        /* --- æ§åˆ¶é …å®¹å™¨ --- */
        .controls-wrapper { max-width: 1000px; margin: 0 auto; }
        .controls-row-1 { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .controls-row-2 { display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;}

        /* è¼¸å…¥æ¡†èˆ‡é¸å–®å„ªåŒ– */
        .search-box { 
            flex: 2; padding: 0 16px; height: 42px; 
            border: 2px solid #e2e8f0; border-radius: 25px; 
            font-size: 15px; outline: none; transition: 0.2s; 
            font-family: 'Noto Sans TC';
            background: #fff;
            min-width: 160px;
        }
        .search-box:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(56, 178, 172, 0.2); }

        .select-pill { 
            padding: 0 20px; height: 42px; border-radius: 25px; 
            border: 2px solid #e2e8f0; font-size: 14px; 
            font-weight: 700; background: white; color: #4a5568; 
            cursor: pointer; outline: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234a5568%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 10px auto;
            padding-right: 30px;
        }
        .select-michelin { border-color: #fc8181; color: var(--michelin-red); background-color: #fff5f5; }

        /* é–‹é—œæŒ‰éˆ• */
        .toggle-wrapper { 
            display: flex; align-items: center; background: white; 
            border: 2px solid #e2e8f0; padding: 4px 12px 4px 4px; 
            border-radius: 25px; height: 42px; cursor: pointer; user-select: none; 
        }
        .toggle-switch { position: relative; width: 36px; height: 22px; margin-right: 8px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #cbd5e0; border-radius: 34px; transition: .3s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .3s; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(14px); }
        .toggle-label { font-size: 14px; font-weight: bold; color: #4a5568; white-space: nowrap; }
        input:checked ~ .toggle-label { color: var(--primary); }

        /* æŒ‰éˆ•ç¾¤ */
        .btn-pill { 
            padding: 0 18px; height: 42px; border-radius: 25px; 
            font-weight: 700; display: inline-flex; align-items: center; 
            justify-content: center; gap: 6px; border: none; 
            font-size: 14px; cursor: pointer; background: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; 
            white-space: nowrap; font-family: 'Noto Sans TC';
        }
        .btn-fav { color: #e53e3e; border: 1px solid #fed7d7; background: #fff5f5; } 
        .btn-fav:hover, .btn-fav.active { background: #e53e3e; color: white; border-color: #e53e3e; }
        
        .btn-gps { color: var(--primary); border: 1px solid #b2f5ea; background: #e6fffa; } 
        .btn-gps:hover, .btn-gps.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .btn-view { background: #2d3748; color: white; border: 1px solid #2d3748; }
        .btn-reset { color: #718096; background: #edf2f7; }
        .btn-reset:hover { background: #cbd5e0; }

        /* --- å±•é–‹/æ”¶åˆç¯©é¸å€æŒ‰éˆ• --- */
        .toggle-filter-btn {
            width: 100%; text-align: center; color: #4a5568; font-size: 13px; font-weight: bold;
            cursor: pointer; padding: 5px 0; margin-top: 5px;
        }
        .toggle-filter-btn:hover { color: var(--primary); }

        /* --- ç¯©é¸å€å¡Š (é è¨­æ”¶åˆ) --- */
        .filter-section { 
            max-width: 1000px; margin: 0 auto 20px auto; 
            background: white; padding: 20px; border-radius: 0 0 16px 16px; 
            box-shadow: var(--shadow); 
            display: none; /* é è¨­éš±è— */
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .label { display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 10px; font-weight: 800; color: #2d3748; font-size: 1em; }
        .label i { color: var(--primary); }

        .city-btn, .district-btn, .type-btn { 
            padding: 6px 14px; border-radius: 20px; border: none; 
            cursor: pointer; font-size: 14px; background: #edf2f7; 
            color: #4a5568; transition: 0.2s; font-family: 'Noto Sans TC';
        }
        .city-btn:hover, .district-btn:hover, .type-btn:hover { background: #e2e8f0; transform: translateY(-1px); }
        .city-btn.active { background: #2d3748; color: white; }
        .district-btn.active { background: var(--primary); color: white; }
        .type-btn { background: white; border: 1px solid #e2e8f0; } 
        .type-btn.active { background: #4a5568; color: white; border-color: #4a5568; }

        /* --- åˆ—è¡¨å€ --- */
        .main-content { padding: 15px; }
        .food-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; max-width: 1200px; margin: 0 auto; }
        
        .food-card { 
            background: white; border-radius: 16px; 
            box-shadow: var(--shadow); overflow: hidden; 
            position: relative; transition: transform 0.2s; border: 1px solid #edf2f7;
        }
        .food-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .card-image-box { height: 180px; background: #f0f0f0; position: relative; }
        .card-image-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .michelin-badge { 
            position: absolute; top: 12px; left: 12px; 
            background: var(--michelin-red); color: white; 
            padding: 4px 10px; border-radius: 20px; 
            font-weight: 700; font-size: 12px; z-index: 5; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            display: flex; align-items: center; gap: 4px;
        }

        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 5; }
        .action-btn { 
            width: 36px; height: 36px; border-radius: 50%; 
            background: rgba(255,255,255,0.95); color: #718096; 
            border: 1px solid rgba(0,0,0,0.05); cursor: pointer; 
            font-size: 1.1em; transition: 0.2s; display:flex; 
            align-items:center; justify-content:center; 
        }
        .action-btn:hover { transform: scale(1.1); color: var(--text-main); }
        .action-btn.is-fav { color: #ff4757; }

        .card-content { padding: 18px; }
        .card-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        
        .card-title { 
            font-size: 1.35em; font-weight: 900; margin: 5px 0 12px 0; 
            color: #1a202c; line-height: 1.3; 
        }
        .rating-badge { 
            font-size: 13px; color: #b7791f; background: #fffbe6; 
            border: 1px solid #f6e05e; padding: 2px 8px; border-radius: 12px; 
            font-weight: bold; display: inline-flex; align-items: center; gap: 3px; 
            vertical-align: middle; margin-left: 8px;
        }
        
        .status-badge { font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: 800; white-space: nowrap; }
        .status-open { background: #c6f6d5; color: #22543d; } 
        .status-closed { background: #edf2f7; color: #718096; }

        .info-row { display: flex; align-items: flex-start; margin-bottom: 6px; color: #4a5568; line-height: 1.5; font-size: 0.9em; }
        .info-icon { margin-right: 8px; color: var(--primary); margin-top: 3px; width: 16px; text-align: center; }

        .btn-group { display: flex; gap: 8px; margin-top: 15px; border-top: 1px solid #edf2f7; padding-top: 12px; }
        .btn-nav, .btn-booking { 
            flex-grow: 1; height: 38px; border-radius: 8px; 
            display: flex; justify-content: center; align-items: center; 
            text-decoration: none; font-weight: 700; font-size: 0.95em; transition: 0.2s; 
        }
        .btn-nav { background: var(--primary); color: white; }
        .btn-nav:hover { background: var(--primary-dark); }
        .btn-booking { background: var(--accent); color: white; }
        .btn-booking:hover { background: #dd6b20; }
        
        .btn-icon { 
            width: 38px; height: 38px; border-radius: 8px; 
            display: flex; justify-content: center; align-items: center; 
            color: #718096; font-size: 1.2em; border: 1px solid #e2e8f0; 
            transition: 0.2s; 
        }
        .bg-web:hover { border-color: var(--accent); color: var(--accent); }

        #loadMoreBtn { 
            display: none; width: 200px; padding: 12px; margin: 30px auto; 
            background: white; border: 2px solid var(--primary); 
            color: var(--primary); font-weight: bold; border-radius: 25px; 
            cursor: pointer; transition: 0.2s; 
        }
        #loadMoreBtn:hover { background: var(--primary); color: white; }

        #mapContainer { display: none; width: 100%; height: 80vh; border-radius: 12px; margin-top: 20px; z-index: 1; border: 1px solid #e2e8f0; }
        
        #toast { visibility: hidden; min-width: 250px; background: #2d3748; color: #fff; text-align: center; border-radius: 30px; padding: 14px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-weight: bold; font-size: 0.95em; }
        #toast.show { visibility: visible; opacity: 1; transition: opacity 0.3s; }
        
        #backToTop { position: fixed; bottom: 85px; right: 20px; width: 45px; height: 45px; background: #2c3e50; color: white; border-radius: 50%; border: none; font-size: 1.2em; display: none; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0.9; transition: 0.2s; }
    </style>
</head>
<body>

    <div id="loadingBar" class="loading-bar"><div class="bar"></div></div>

    <header>
        <h1>ğŸ‡¹ğŸ‡¼ å…¨å°ç¾é£Ÿåœ°åœ–</h1>
        <p class="subtitle">v29.0 æ——è‰¦ä»‹é¢ç‰ˆ</p>
        
        <div class="controls-wrapper">
            <div class="controls-row-1">
                <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹åº—åã€é—œéµå­—...">
                <select id="michelinSelect" class="select-pill select-michelin" onchange="applyFiltersAndSort()">
                    <option value="all">â­• ä¸é™ç±³å…¶æ—ç­‰ç´š</option>
                    <option value="any">âœ¨ æ‰€æœ‰ç±³å…¶æ—é¤å»³</option>
                    <option value="3">â­â­â­ ç±³å…¶æ—ä¸‰æ˜Ÿ</option>
                    <option value="2">â­â­ ç±³å…¶æ—äºŒæ˜Ÿ</option>
                    <option value="1">â­ ç±³å…¶æ—ä¸€æ˜Ÿ</option>
                    <option value="bib">ğŸ˜‹ ç±³å…¶æ—å¿…æ¯”ç™»æ¨è–¦</option>
                    <option value="selected">ğŸ½ï¸ ç±³å…¶æ—å…¥é¸é¤å»³</option>
                </select>
                <label class="toggle-wrapper">
                    <div class="toggle-switch"><input type="checkbox" id="openFilter" onchange="toggleOpenFilter()"><span class="slider"></span></div>
                    <span class="toggle-label">ç‡Ÿæ¥­ä¸­</span>
                </label>
                <button class="btn-pill btn-reset" onclick="resetAllFilters()"><i class="fas fa-undo"></i> é‡ç½®</button>
            </div>
            <div class="controls-row-2">
                <select id="rangeSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="99999">ğŸ“ è·é›¢: å…¨éƒ¨</option>
                    <option value="1">1 å…¬é‡Œå…§</option>
                    <option value="5" selected>5 å…¬é‡Œå…§</option>
                </select>
                <select id="sortSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="dist" selected>ğŸ“ è·é›¢è¿‘â†’é </option>
                    <option value="rating">â­ è©•åˆ†é«˜â†’ä½</option>
                </select>
                <button id="gpsBtn" class="btn-pill btn-gps" onclick="findNearby()"><i class="fas fa-location-arrow"></i> é™„è¿‘</button>
                <button id="favFilterBtn" class="btn-pill btn-fav" onclick="toggleFavFilter()">â¤ï¸ å£è¢‹</button>
                <button id="viewBtn" class="btn-pill btn-view" onclick="toggleViewMode()"><i class="fas fa-map-marked-alt"></i> åœ°åœ–</button>
            </div>
            
            <div class="toggle-filter-btn" onclick="toggleFilterSection()">
                <i class="fas fa-chevron-down"></i> å±•é–‹é€²éšç¯©é¸ (ç¸£å¸‚/é¡åˆ¥)
            </div>
        </div>
    </header>

    <div id="loadingMsg" class="loading" style="text-align:center;padding:20px;font-weight:bold;color:#38b2ac;"></div>
    
    <div id="filterSection" class="filter-section">
        <span class="label"><i class="fas fa-city"></i> é¸æ“‡ç¸£å¸‚</span>
        <div id="cityButtons" class="btn-container"></div>
        
        <div id="districtSection" style="display:none; margin-top:15px; border-top:1px dashed #eee; padding-top:15px;">
            <span class="label"><i class="fas fa-map-signs"></i> é¸æ“‡åœ°å€</span>
            <div id="districtButtons" class="btn-container"></div>
        </div>
        
        <div style="margin-top:15px; border-top:1px dashed #eee; padding-top:15px;">
            <span class="label"><i class="fas fa-utensils"></i> ç¾é£Ÿé¡åˆ¥</span>
            <div id="typeButtons" class="btn-container"></div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="food-list" id="foodContainer"></div>
        <button id="loadMoreBtn" onclick="loadMore()">ğŸ‘‡ è¼‰å…¥æ›´å¤šé¤å»³</button>
        <div id="mapContainer"></div>
    </div>

    <div id="toast"></div>
    <button id="backToTop" onclick="scrollToTop()"><i class="fas fa-arrow-up"></i></button>

    <script>
        // âš ï¸ è«‹ç¢ºèª Apps Script éƒ¨ç½²ç¶²å€
        const scriptUrl = 'YOUR_GAS_SCRIPT_URL_HERE';
        const sheetID = '2PACX-1vRJXAD8XnJT4MfBoaSSCpByuNcUVwlXTCL702vtUBDsg8aZ__v-_yxXVRVQntuqaJY3eecAwq7qZDIb';
        const rawUrl = `https://docs.google.com/spreadsheets/d/e/${sheetID}/pub?output=csv&cache_bust=${Date.now()}`;
        const proxyList = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url=', 'https://api.codetabs.com/v1/proxy?quest='];

        let appState = { allData: [], currentCity: "å…¨å°", currentDistrict: "å…¨éƒ¨", currentType: "å…¨éƒ¨", currentKeyword: "", isShowingFavs: false, isShowingNearby: false, isOpenOnly: false, myFavorites: [], viewMode: 'list', displayedCount: 0, filteredData: [] };
        const BATCH_SIZE = 30;
        let map = null, markersGroup = null;

        try { appState.myFavorites = JSON.parse(localStorage.getItem('myFoodFavorites')) || []; } catch (e) {}

        init();

        function init() {
            document.getElementById('searchInput').value = "";
            document.getElementById('michelinSelect').value = "all";
            document.getElementById('openFilter').checked = false;
            document.getElementById('rangeSelect').value = "99999";
            document.getElementById('sortSelect').value = "dist";
            
            window.onscroll = () => document.getElementById('backToTop').style.display = (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) ? "flex" : "none";

            const cachedData = localStorage.getItem('foodMapData');
            const cachedTime = localStorage.getItem('foodMapData_ts');
            
            if (cachedData && cachedTime && (Date.now() - cachedTime < 3600000)) {
                processData(JSON.parse(cachedData), true);
                fetchDataSmart(true);
            } else {
                document.getElementById('loadingMsg').innerText = "â³ æ­£åœ¨ä¸‹è¼‰è³‡æ–™...";
                document.getElementById('loadingBar').style.display = 'block';
                fetchDataSmart(false);
            }
            
            document.getElementById('searchInput').addEventListener('input', (e) => {
                setTimeout(() => { appState.currentKeyword = e.target.value.toLowerCase(); appState.isShowingFavs = false; applyFiltersAndSort(); }, 300);
            });
        }

        // âœ¨ å±•é–‹/æ”¶åˆç¯©é¸å€
        function toggleFilterSection() {
            const fs = document.getElementById('filterSection');
            const btn = document.querySelector('.toggle-filter-btn');
            if (fs.style.display === 'none' || fs.style.display === '') {
                fs.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-chevron-up"></i> æ”¶åˆç¯©é¸';
            } else {
                fs.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-chevron-down"></i> å±•é–‹é€²éšç¯©é¸ (ç¸£å¸‚/é¡åˆ¥)';
            }
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        function fetchDataSmart(isBackground) {
            const apiPromise = new Promise((resolve, reject) => {
                if (scriptUrl && scriptUrl.includes('script.google.com') && !scriptUrl.includes('YOUR_GAS')) {
                    fetch(scriptUrl).then(r => r.json()).then(data => resolve(data)).catch(e => reject(e));
                } else reject("No API");
            });
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 3000));

            Promise.race([apiPromise, timeoutPromise])
                .then(data => {
                    localStorage.setItem('foodMapData', JSON.stringify(data));
                    localStorage.setItem('foodMapData_ts', Date.now());
                    processData(data, true);
                    document.getElementById('loadingBar').style.display = 'none';
                    document.getElementById('loadingMsg').style.display = 'none';
                })
                .catch(() => tryFetchCSV(0, isBackground));
        }

        function tryFetchCSV(idx, bg) {
            if (idx >= proxyList.length) { if(!bg) document.getElementById('loadingMsg').innerHTML = "âš ï¸ é€£ç·šå¤±æ•—"; return; }
            Papa.parse(proxyList[idx] + encodeURIComponent(rawUrl), {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    localStorage.setItem('foodMapData', JSON.stringify(results.data));
                    localStorage.setItem('foodMapData_ts', Date.now());
                    processData(results.data, true);
                    document.getElementById('loadingBar').style.display = 'none';
                    document.getElementById('loadingMsg').style.display = 'none';
                },
                error: () => tryFetchCSV(idx + 1, bg)
            });
        }

        function processData(data, refreshUI) {
            appState.allData = data.filter(item => item.name).map(item => {
                const n = {};
                Object.keys(item).forEach(k => n[k ? k.toLowerCase().trim() : ""] = item[k] || "");
                if(!n.city) n.city = "æœªåˆ†é¡";
                n.id = `${n.city}-${n.name}`;
                n.lat = parseFloat(n.lat); n.lng = parseFloat(n.lng);
                n.rating = parseFloat(n.rating || 0);
                n.michelinType = n.michelin ? n.michelin.toString().toLowerCase() : "";
                if (n.hours) n.parsedSchedule = parseStandardSchedule(n.hours);
                return n;
            });
            if(refreshUI) { renderCityButtons(); renderTypeButtons(); applyFiltersAndSort(); }
        }

        function parseStandardSchedule(str) {
            let schedule = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]};
            const map = {'æ—¥':0, 'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6};
            const allDays = [0,1,2,3,4,5,6];
            let parts = str.split(';');
            let closedDays = [];
            
            parts.forEach(p => {
                if (p.includes("å…¬ä¼‘")) {
                    for(let k in map) if(p.includes("é€±"+k)) closedDays.push(map[k]);
                }
            });

            parts.forEach(p => {
                if (p.includes("å…¬ä¼‘")) return; 
                let times = p.match(/(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/g);
                if (!times) return;

                let specificDays = [];
                let dayPart = p.match(/\((.*?)\)/);
                if (dayPart) {
                    let dStr = dayPart[1];
                    dStr.replace(/é€±([æ—¥ä¸€äºŒä¸‰å››äº”å…­])\s*-\s*é€±([æ—¥ä¸€äºŒä¸‰å››äº”å…­])/g, (m, d1, d2) => {
                        let s = map[d1], e = map[d2];
                        if (e < s) e += 7;
                        for(let i=s; i<=e; i++) specificDays.push(i%7);
                        return "";
                    });
                    for(let k in map) if(dStr.includes("é€±"+k)) specificDays.push(map[k]);
                } else {
                    specificDays = allDays;
                }

                specificDays.forEach(d => {
                    if (!closedDays.includes(d)) {
                        times.forEach(t => {
                            let [s, e] = t.split('-');
                            let start = parseTime(s), end = parseTime(e);
                            if (end < start) end += 1440;
                            schedule[d].push([start, end]);
                        });
                    }
                });
            });
            return schedule;
        }

        function parseTime(t) {
            let p = t.split(':');
            return parseInt(p[0]) * 60 + parseInt(p[1]);
        }

        function checkIsOpen(parsedSchedule) {
            if (!parsedSchedule) return false;
            const now = new Date();
            const d = now.getDay();
            const m = now.getHours() * 60 + now.getMinutes();
            const ranges = parsedSchedule[d];
            if (!ranges || ranges.length === 0) return false;
            for (let i = 0; i < ranges.length; i++) {
                const [s, e] = ranges[i];
                let check = m;
                if (check < s && e >= 1440) check += 1440;
                if (check >= s && check <= e) return true;
            }
            return false;
        }

        function applyFiltersAndSort() {
            let res = [...appState.allData];
            if (appState.isShowingFavs) res = res.filter(i => appState.myFavorites.includes(i.id));
            else {
                if (appState.currentKeyword) res = res.filter(i => i.name.toLowerCase().includes(appState.currentKeyword));
                else {
                    if (appState.currentCity !== "å…¨å°") {
                        res = res.filter(i => i.city === appState.currentCity);
                        if (appState.currentDistrict !== "å…¨éƒ¨") res = res.filter(i => i.district === appState.currentDistrict);
                    }
                }
                if (appState.currentType !== "å…¨éƒ¨") res = res.filter(i => i.type === appState.currentType);
            }

            if (appState.isOpenOnly) res = res.filter(i => checkIsOpen(i.parsedSchedule));

            const mode = document.getElementById('michelinSelect').value;
            if (mode !== 'all') {
                if (mode === 'any') res = res.filter(i => i.michelinType !== "");
                else res = res.filter(i => i.michelinType === mode);
            }

            if (appState.isShowingNearby) {
                const limit = parseFloat(document.getElementById('rangeSelect').value);
                res = res.filter(i => i.distance <= limit);
            }

            const sort = document.getElementById('sortSelect').value;
            res.sort((a, b) => sort === 'rating' ? b.rating - a.rating : a.distance - b.distance);

            appState.filteredData = res;
            appState.displayedCount = 0;
            document.getElementById('foodContainer').innerHTML = '';
            
            if (appState.viewMode === 'list') loadMore(); else renderMap(res);
        }

        function loadMore() {
            const container = document.getElementById('foodContainer');
            const total = appState.filteredData.length;
            const start = appState.displayedCount;
            const end = Math.min(start + BATCH_SIZE, total);
            
            if (start >= total) {
                if (total === 0) container.innerHTML = '<p style="text-align:center;padding:40px;color:#666;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„åº—å®¶</p>';
                document.getElementById('loadMoreBtn').style.display = 'none';
                return;
            }

            const frag = document.createDocumentFragment();
            for (let i = start; i < end; i++) frag.appendChild(createCard(appState.filteredData[i]));
            container.appendChild(frag);
            appState.displayedCount = end;
            
            document.getElementById('loadMoreBtn').style.display = (end < total) ? 'block' : 'none';
        }

        function createCard(item) {
            const isOpen = checkIsOpen(item.parsedSchedule);
            const statusHtml = isOpen ? '<span class="status-badge status-open">ğŸŸ¢ ç‡Ÿæ¥­ä¸­</span>' : '<span class="status-badge status-closed">âšª ä¼‘æ¯ä¸­</span>';
            const michelin = getMichelinBadge(item.michelinType);
            const isFav = appState.myFavorites.includes(item.id) ? 'is-fav' : '';
            let btns = '';
            if (item.booking) btns += `<a href="${item.booking}" target="_blank" class="btn-booking"><i class="fas fa-calendar-check"></i> ç·šä¸Šè¨‚ä½</a>`;
            btns += `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name)}" target="_blank" class="btn-nav"><i class="fas fa-location-arrow"></i> å°èˆª</a>`;
            if(item.website) btns += `<a href="${item.website}" class="btn-icon bg-web" target="_blank"><i class="fas fa-globe"></i></a>`;
            
            const div = document.createElement('div');
            div.className = 'food-card';
            div.innerHTML = `
                <div class="card-image-box">
                    ${michelin}
                    ${item.image ? `<img src="${item.image}" loading="lazy">` : `<div class="card-placeholder" style="background:#ddd"><i class="fas fa-utensils"></i></div>`}
                    <div class="card-actions">
                        <button class="action-btn share-btn" onclick="shareStore('${item.name}')"><i class="fas fa-share-alt"></i></button>
                        <button class="action-btn btn-love ${isFav}" onclick="toggleHeart('${item.id}', this)"><i class="fas fa-heart"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="card-top-row">
                        <div class="meta-group"><span class="meta-tag">${item.city}</span><span class="meta-tag">${item.type}</span></div>
                        ${statusHtml}
                    </div>
                    <h3 class="card-title">${item.name} <span class="rating-badge">â­ ${item.rating}</span></h3>
                    <div class="info-row"><i class="far fa-clock info-icon"></i><span>${item.hours}</span></div>
                    <div class="info-row"><i class="fas fa-phone-alt info-icon"></i><span>${item.phone||"ç„¡"}</span></div>
                    <div class="info-row"><i class="fas fa-map-marker-alt info-icon"></i><span>${item.address}</span></div>
                    <div class="btn-group">${btns}</div>
                </div>
            `;
            return div;
        }

        // æ­£åï¼šä¿®æ­£ç‚ºå…¨ç¨±
        function getMichelinBadge(t) { 
            if(!t)return""; 
            const map={'3':'ç±³å…¶æ—ä¸‰æ˜Ÿ','2':'ç±³å…¶æ—äºŒæ˜Ÿ','1':'ç±³å…¶æ—ä¸€æ˜Ÿ','bib':'ç±³å…¶æ—å¿…æ¯”ç™»æ¨è–¦','selected':'ç±³å…¶æ—å…¥é¸é¤å»³'}; 
            return `<div class="michelin-badge"><i class="fas fa-award"></i> ${map[t]||''}</div>`; 
        }

        function resetAllFilters() { 
            appState = { ...appState, isShowingFavs:false, isShowingNearby:false, isOpenOnly:false, currentKeyword:"", currentType:"å…¨éƒ¨", currentCity:"å…¨å°", currentDistrict:"å…¨éƒ¨" };
            document.getElementById('searchInput').value = "";
            document.getElementById('michelinSelect').value = "all";
            document.getElementById('openFilter').checked = false;
            document.getElementById('rangeSelect').value = "99999";
            
            updateUIState(); renderTypeButtons(); renderCityButtons(); applyFiltersAndSort();
            showToast("ğŸ”„ å·²é‡ç½®");
        }
        
        function renderCityButtons() { 
            const cities = ["å…¨å°", ...new Set(appState.allData.map(i=>i.city))];
            const div = document.getElementById('cityButtons'); div.innerHTML = "";
            cities.forEach(c => {
                const b = document.createElement('button'); b.className = `city-btn ${c===appState.currentCity?'active':''}`; b.innerText = c;
                b.onclick = () => { 
                    appState.currentCity = c; 
                    appState.currentDistrict = "å…¨éƒ¨"; 
                    renderDistrictButtons(); 
                    renderCityButtons(); 
                    applyFiltersAndSort(); 
                };
                div.appendChild(b);
            });
            renderDistrictButtons(); 
        }

        function renderDistrictButtons() {
            const districtSection = document.getElementById('districtSection');
            const districtDiv = document.getElementById('districtButtons');
            
            if (appState.currentCity === "å…¨å°") {
                districtSection.style.display = 'none';
                return;
            }
            
            districtSection.style.display = 'block';
            districtDiv.innerHTML = "";
            
            const cityData = appState.allData.filter(i => i.city === appState.currentCity);
            const districts = ["å…¨éƒ¨", ...new Set(cityData.map(i => i.district))];
            
            districts.forEach(d => {
                const b = document.createElement('button'); 
                b.className = `district-btn ${d===appState.currentDistrict?'active':''}`; 
                b.innerText = d;
                b.onclick = () => { 
                    appState.currentDistrict = d; 
                    renderDistrictButtons(); 
                    applyFiltersAndSort(); 
                };
                districtDiv.appendChild(b);
            });
        }

        function renderTypeButtons() { const types = ["å…¨éƒ¨", ...new Set(appState.allData.map(i => i.type).filter(t => t))]; const container = document.getElementById('typeButtons'); container.innerHTML = ''; types.forEach(type => { const btn = document.createElement('button'); btn.className = `type-btn ${type===appState.currentType?'active':''}`; btn.innerText = type; btn.onclick = () => { appState.currentType = type; renderTypeButtons(); applyFiltersAndSort(); }; container.appendChild(btn); }); }
        function toggleFavFilter() { appState.isShowingFavs = !appState.isShowingFavs; appState.isShowingNearby = false; updateUIState(); applyFiltersAndSort(); }
        function toggleHeart(id, btn) { const idx = appState.myFavorites.indexOf(id); if(idx===-1) { appState.myFavorites.push(id); btn.classList.add('is-fav'); } else { appState.myFavorites.splice(idx,1); btn.classList.remove('is-fav'); if(appState.isShowingFavs) applyFiltersAndSort(); } localStorage.setItem('myFoodFavorites', JSON.stringify(appState.myFavorites)); }
        function findNearby() { appState.isShowingNearby = true; appState.isShowingFavs = false; appState.currentCity = "å…¨å°"; updateUIState(); navigator.geolocation.getCurrentPosition(p => { appState.allData.forEach(i => i.distance = calcDist(p.coords.latitude, p.coords.longitude, i.lat, i.lng)); document.getElementById('sortSelect').value = 'dist'; applyFiltersAndSort(); }); }
        function calcDist(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180; const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); }
        function formatDistance(km) { if (km >= 9999) return ""; if (km < 1) return (km * 1000).toFixed(0) + " m"; return km.toFixed(1) + " km"; }
        function toggleViewMode() { appState.viewMode = appState.viewMode==='list'?'map':'list'; document.getElementById('viewBtn').innerHTML = appState.viewMode==='list'?'<i class="fas fa-map-marked-alt"></i> åœ°åœ–':'<i class="fas fa-list"></i> åˆ—è¡¨'; document.getElementById('foodContainer').style.display = appState.viewMode==='list'?'grid':'none'; document.getElementById('mapContainer').style.display = appState.viewMode==='map'?'block':'none'; document.getElementById('loadMoreBtn').style.display = appState.viewMode==='list'?'block':'none'; if(appState.viewMode==='map') setTimeout(() => { if(!map) initMap(); map.invalidateSize(); applyFiltersAndSort(); }, 100); }
        function updateUIState() { const gpsBtn = document.getElementById('gpsBtn'); const favBtn = document.getElementById('favFilterBtn'); if (appState.isShowingFavs) { favBtn.classList.add('active'); favBtn.innerText = "ğŸ”™ å›åˆ—è¡¨"; } else { favBtn.classList.remove('active'); favBtn.innerText = "â¤ï¸ å£è¢‹"; } if (appState.isShowingNearby) { gpsBtn.classList.add('active'); document.getElementById('cityButtons').style.display = 'none'; } else { gpsBtn.classList.remove('active'); document.getElementById('cityButtons').style.display = 'flex'; } renderCityButtons(); }
        function initMap() { if (map) return; map = L.map('mapContainer').setView([23.9738, 120.9820], 7); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map); markersGroup = L.markerClusterGroup().addTo(map); }
        function renderMap(data) { if (!map) initMap(); markersGroup.clearLayers(); const valid = data.filter(d => d.lat && d.lng); if (valid.length === 0) return; const bounds = []; valid.forEach(i => { const m = L.marker([i.lat, i.lng]); m.bindPopup(createCard(i).outerHTML); markersGroup.addLayer(m); bounds.push([i.lat, i.lng]); }); if (bounds.length) map.fitBounds(bounds); }
        function shareStore(name) { if(navigator.share) navigator.share({title:name, text:name, url:window.location.href}); else showToast("å·²è¤‡è£½é€£çµ"); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText=m; t.className="show"; setTimeout(()=>t.className="", 3000); }
        function toggleOpenFilter() { appState.isOpenOnly = document.getElementById('openFilter').checked; applyFiltersAndSort(); }
    </script>
</body>
</html>
