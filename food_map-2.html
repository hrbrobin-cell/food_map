<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°ç¾é£Ÿåœ°åœ– (v26.0 é‡ç½®ä¿®å¾©ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        /* --- CSS æ¨£å¼å€ (èˆ‡ v25 ç›¸åŒ) --- */
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; color: #222; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2.2em; letter-spacing: 1px; font-weight: 900; }
        .subtitle { color: #555; font-size: 1.1em; margin-bottom: 25px; }
        .loading-bar { width: 100%; background: #e2e8f0; height: 4px; position: fixed; top: 0; left: 0; z-index: 9999; display: none; }
        .loading-bar .bar { height: 100%; background: #bd2333; animation: load 1.5s infinite ease-in-out; width: 50%; }
        @keyframes load { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
        .controls-wrapper { max-width: 950px; margin: 0 auto 20px auto; }
        .controls-row-1 { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 12px; }
        .search-box { flex: 2; padding: 12px 20px; border: 2px solid #ccc; min-width: 180px; border-radius: 30px; font-size: 16px; outline: none; transition: 0.3s; }
        .search-box:focus { border-color: #bd2333; box-shadow: 0 0 8px rgba(189, 35, 51, 0.2); }
        .select-pill { min-width: 140px; padding: 0 15px; border: 2px solid #ccc; border-radius: 30px; height: 48px; font-size: 15px; outline: none; background: white; cursor: pointer; color: #333; font-weight: bold; }
        .select-michelin { border: 2px solid #bd2333; color: #bd2333; background: #fff5f5; }
        .toggle-wrapper { display: flex; align-items: center; background: white; border: 2px solid #ccc; padding: 5px 15px 5px 5px; border-radius: 30px; height: 48px; box-sizing: border-box; cursor: pointer; user-select: none; transition: 0.2s; white-space: nowrap; }
        .toggle-wrapper:hover { border-color: #38b2ac; }
        .toggle-switch { position: relative; width: 40px; height: 24px; margin-right: 8px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input:checked + .slider { background-color: #38b2ac; }
        input:checked + .slider:before { transform: translateX(16px); }
        .toggle-label { font-size: 15px; font-weight: bold; color: #555; }
        input:checked ~ .toggle-label { color: #38b2ac; }
        .controls-row-2 { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .btn-pill { padding: 0 20px; height: 48px; border-radius: 30px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.3s; border: none; font-size: 15px; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-fav { background-color: #fff; border: 2px solid #e53e3e; color: #e53e3e; }
        .btn-fav:hover, .btn-fav.active { background-color: #e53e3e; color: white; }
        .btn-gps { background-color: #fff; border: 2px solid #38b2ac; color: #38b2ac; }
        .btn-gps:hover, .btn-gps.active { background-color: #38b2ac; color: white; }
        .btn-gps.loading { opacity: 0.7; cursor: wait; pointer-events: none; }
        .btn-view { background-color: #2d3748; color: white; border: 2px solid #2d3748; }
        .btn-view:hover { background-color: #4a5568; }
        .btn-reset { background-color: #718096; color: white; border: 2px solid #718096; }
        .btn-reset:hover { background-color: #4a5568; transform: rotate(180deg); }
        .loading { text-align: center; color: #38b2ac; font-weight: bold; padding: 20px; font-size: 1.2em; display: none; }
        .error-msg { color: #e53e3e; background: #fff5f5; padding: 15px; border-radius: 10px; border: 1px solid #fc8181; display: inline-block; text-align: left; }
        .filter-section { max-width: 1000px; margin: 0 auto 20px auto; text-align: center; }
        .btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .label { font-size: 16px; color: #666; margin-bottom: 10px; display: block; font-weight: bold; }
        .btn { border: none; padding: 8px 16px; border-radius: 25px; cursor: pointer; font-size: 15px; transition: 0.2s; font-weight: 500; }
        .city-btn { background-color: #e2e8f0; color: #4a5568; }
        .city-btn.active { background-color: #2d3748; color: white; transform: scale(1.05); box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
        .district-btn { background-color: #e6fffa; color: #2c7a7b; border: 1px solid #b2f5ea; }
        .district-btn.active { background-color: #38b2ac; color: white; border-color: #38b2ac; }
        .type-btn { background-color: white; border: 2px solid #eee; color: #444; padding: 8px 16px; border-radius: 25px; cursor: pointer; font-size: 15px; transition: 0.2s; display: flex; align-items: center; gap: 6px; font-weight: bold; }
        .type-btn:hover { background-color: #f7fafc; transform: translateY(-2px); border-color: #cbd5e0; }
        .type-btn.active { background-color: #4a5568; color: white; border-color: #4a5568; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scale(1.05); }
        .type-btn i { font-size: 1.2em; }
        .food-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; }
        #mapContainer { display: none; width: 100%; height: 75vh; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 2px solid #fff; z-index: 1; }
        .food-card { background: white; border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; animation: fadeIn 0.4s; position: relative; }
        .card-image-box { width: 100%; height: 200px; position: relative; overflow: hidden; background-color: #f0f0f0; }
        .card-image-box img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .food-card:hover .card-image-box img { transform: scale(1.05); }
        .michelin-badge { position: absolute; top: 10px; left: 10px; z-index: 5; padding: 5px 12px; border-radius: 4px; color: white; font-weight: 800; font-size: 13px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px; animation: popIn 0.5s; }
        .bg-star { background: #bd2333; }
        .bg-bib { background: #bd2333; }
        .bg-selected { background: #333; }
        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 5; }
        .action-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); color: white; font-size: 1.2em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .action-btn:hover { background: rgba(0,0,0,0.7); transform: scale(1.1); }
        .action-btn.is-fav { background: white; color: #ff4757; }
        .action-btn.share-btn:hover { background: white; color: #3182ce; }
        .card-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .card-placeholder i { font-size: 3.5em; margin-bottom: 10px; opacity: 0.95; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
        .card-placeholder span { font-size: 1.4em; font-weight: bold; letter-spacing: 2px; opacity: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .card-content { padding: 20px; display: flex; flex-direction: column; flex-grow: 1; }
        .card-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
        .meta-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .meta-tag { font-size: 13px; color: #444; background: #edf2f7; padding: 4px 10px; border-radius: 6px; display: inline-block; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .meta-tag:hover { background: #cbd5e0; color: #1a202c; }
        .card-title { margin: 5px 0 15px 0; color: #1a202c; font-size: 1.6em; font-weight: 800; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; line-height: 1.3; }
        .rating-badge { font-size: 14px; color: #b7791f; background: #fffbe6; border: 1px solid #f6e05e; padding: 3px 10px; border-radius: 15px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; vertical-align: middle; }
        .dist-badge { font-size: 14px; color: #2d3748; background: #e2e8f0; padding: 3px 10px; border-radius: 15px; display: inline-flex; align-items: center; gap: 4px; vertical-align: middle; font-weight: bold; }
        .status-badge { font-size: 14px; padding: 5px 12px; border-radius: 20px; font-weight: 800; white-space: nowrap; margin-left: auto; letter-spacing: 0.5px; }
        .status-open { background-color: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4; } 
        .status-closed { background-color: #edf2f7; color: #718096; border: 1px solid #cbd5e0; } 
        .info-row { display: flex; align-items: flex-start; margin-bottom: 10px; font-size: 1.05em; color: #333; line-height: 1.5; }
        .info-icon { margin-right: 12px; width: 18px; text-align: center; color: #38b2ac; margin-top: 3px; font-size: 1.1em; }
        .hours-text { color: #e53e3e; font-weight: bold; }
        .note { background: #f8f9fa; color: #555; padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 0.95em; line-height: 1.6; }
        .btn-group { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; }
        .btn-nav { flex-grow: 1; height: 44px; background-color: #38b2ac; color: white; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-weight: bold; font-size: 1em; transition: 0.2s; box-shadow: 0 3px 6px rgba(56, 178, 172, 0.25); }
        .btn-nav:hover { background-color: #319795; transform: translateY(-2px); }
        .btn-booking { flex-grow: 1; height: 44px; background-color: #ed8936; color: white; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-weight: bold; font-size: 1em; transition: 0.2s; box-shadow: 0 3px 6px rgba(237, 137, 54, 0.25); }
        .btn-booking:hover { background-color: #dd6b20; transform: translateY(-2px); }
        .btn-icon { width: 44px; height: 44px; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 1.3em; transition: 0.2s; color: white; border: 1px solid #eee; flex-shrink: 0; }
        .btn-icon:hover { transform: translateY(-2px); filter: brightness(0.95); }
        .bg-web { color: #ed8936; } .bg-fb { color: #1877F2; } .bg-ig { color: #d6249f; } .bg-yt { color: #FF0000; } 
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 30px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; font-size: 17px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }
        #backToTop { position: fixed; bottom: 85px; right: 20px; width: 45px; height: 45px; background: #2c3e50; color: white; border-radius: 50%; border: none; font-size: 1.2em; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 999; display: none; align-items: center; justify-content: center; transition: 0.3s; opacity: 0.9; }
        #backToTop:hover { transform: translateY(-3px); background: #38b2ac; }
        #loadMoreBtn { display: none; width: 100%; padding: 15px; margin-top: 20px; background: #fff; border: 2px solid #38b2ac; color: #38b2ac; font-weight: bold; border-radius: 12px; cursor: pointer; font-size: 1.1em; transition: 0.3s; }
        #loadMoreBtn:hover { background: #38b2ac; color: white; }
        .leaflet-popup-content-wrapper { border-radius: 12px; overflow: hidden; padding: 0; }
        .leaflet-popup-content { margin: 0; width: 260px !important; }
        .map-popup-card { font-family: "Microsoft JhengHei"; }
        .map-popup-header { background: #38b2ac; color: white; padding: 10px; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .map-popup-body { padding: 15px; }
        .map-popup-info { margin-bottom: 5px; font-size: 0.95em; color: #444; display: flex; align-items: center; gap: 5px; }
        .map-popup-btn { display: block; text-align: center; background: #2d3748; color: white; padding: 8px; margin-top: 10px; border-radius: 6px; text-decoration: none; font-weight: bold; }
        #debugLog { margin-top: 50px; padding: 15px; background: #2d3748; color: #00ff00; font-family: monospace; border-radius: 8px; font-size: 12px; max-height: 200px; overflow-y: auto; display: none; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loadingBar" class="loading-bar"><div class="bar"></div></div>

    <header>
        <h1>ğŸ‡¹ğŸ‡¼ å…¨å°ç¾é£Ÿåœ°åœ–</h1>
        <p class="subtitle">v26.0 é‡ç½®ä¿®å¾©ç‰ˆ (è¨‚ä½+ç±³å…¶æ—+æ¥µé€Ÿ)</p>
        
        <div class="controls-wrapper">
            <div class="controls-row-1">
                <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹åº—å/é—œéµå­—...">
                <select id="michelinSelect" class="select-pill select-michelin" onchange="applyFiltersAndSort()">
                    <option value="all">â­• ä¸é™ç±³å…¶æ—ç­‰ç´š (é¡¯ç¤ºå…¨éƒ¨)</option>
                    <option value="any">âœ¨ é¡¯ç¤ºæ‰€æœ‰ç±³å…¶æ—</option>
                    <option value="3">â­â­â­ ä¸‰æ˜Ÿ</option>
                    <option value="2">â­â­ äºŒæ˜Ÿ</option>
                    <option value="1">â­ ä¸€æ˜Ÿ</option>
                    <option value="bib">ğŸ˜‹ å¿…æ¯”ç™»æ¨è–¦</option>
                    <option value="selected">ğŸ½ï¸ å…¥é¸é¤å»³</option>
                </select>
                <label class="toggle-wrapper">
                    <div class="toggle-switch">
                        <input type="checkbox" id="openFilter" onchange="toggleOpenFilter()">
                        <span class="slider"></span>
                    </div>
                    <span class="toggle-label">ç‡Ÿæ¥­ä¸­</span>
                </label>
                <button class="btn-pill btn-reset" onclick="resetAllFilters()" title="æ¸…é™¤æ‰€æœ‰ç¯©é¸æ¢ä»¶"><i class="fas fa-undo"></i> é‡ç½®</button>
            </div>

            <div class="controls-row-2">
                <select id="rangeSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="99999">ğŸ“ è·é›¢: å…¨éƒ¨</option>
                    <option value="1">1 å…¬é‡Œå…§</option>
                    <option value="3">3 å…¬é‡Œå…§</option>
                    <option value="5" selected>5 å…¬é‡Œå…§</option>
                    <option value="10">10 å…¬é‡Œå…§</option>
                </select>
                <select id="sortSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="dist" selected>ğŸ“ è·é›¢è¿‘â†’é </option>
                    <option value="rating">â­ è©•åˆ†é«˜â†’ä½</option>
                </select>
                <button id="gpsBtn" class="btn-pill btn-gps" onclick="findNearby()"><i class="fas fa-location-arrow"></i> é™„è¿‘</button>
                <button id="favFilterBtn" class="btn-pill btn-fav" onclick="toggleFavFilter()">â¤ï¸ å£è¢‹</button>
                <button id="viewBtn" class="btn-pill btn-view" onclick="toggleViewMode()"><i class="fas fa-map-marked-alt"></i> åœ°åœ–</button>
            </div>
        </div>
    </header>

    <div id="loadingMsg" class="loading"></div>
    
    <div class="filter-section" id="filterSection">
        <span class="label">1. ç¾é£Ÿé¡åˆ¥ (å¯å¿«é€Ÿç¯©é¸)</span>
        <div id="typeButtons" class="btn-container"></div>
        <span class="label">2. é¸æ“‡ç¸£å¸‚ (å…¨å°ç¸½è¦½)</span>
        <div id="cityButtons" class="btn-container"></div>
        <div id="districtSection" style="display:none;">
            <span class="label">3. é¸æ“‡åœ°å€</span>
            <div id="districtButtons" class="btn-container"></div>
        </div>
    </div>
    
    <div class="food-list" id="foodContainer"></div>
    <div style="text-align:center; padding-bottom:30px;">
        <button id="loadMoreBtn" onclick="loadMore()">ğŸ‘‡ è¼‰å…¥æ›´å¤šé¤å»³</button>
    </div>

    <div id="mapContainer"></div>
    <div id="debugLog"><strong>System Log:</strong><br></div>
    <div id="toast"></div>
    <button id="backToTop" onclick="scrollToTop()" title="å›åˆ°é ‚éƒ¨"><i class="fas fa-arrow-up"></i></button>

    <script>
        function log(msg) {
            console.log(msg);
            const debugDiv = document.getElementById('debugLog');
            if(debugDiv.style.display !== 'block') debugDiv.style.display = 'block';
            debugDiv.innerHTML += `> ${msg}<br>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        window.onerror = function(msg, src, l, c, err) { console.error(msg); };
        
        const scriptUrl = 'YOUR_GAS_SCRIPT_URL_HERE';
        const sheetID = '2PACX-1vRJXAD8XnJT4MfBoaSSCpByuNcUVwlXTCL702vtUBDsg8aZ__v-_yxXVRVQntuqaJY3eecAwq7qZDIb';
        const rawUrl = `https://docs.google.com/spreadsheets/d/e/${sheetID}/pub?output=csv&cache_bust=${Date.now()}`;
        const proxyList = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url=', 'https://api.codetabs.com/v1/proxy?quest='];

        let appState = { 
            allData: [], currentCity: "å…¨å°", currentDistrict: "å…¨éƒ¨", currentType: "å…¨éƒ¨", currentKeyword: "", 
            isShowingFavs: false, isShowingNearby: false, isOpenOnly: false, 
            myFavorites: [], viewMode: 'list',
            displayedCount: 0, filteredData: []
        };
        const BATCH_SIZE = 30;
        let map = null;
        let markersGroup = null;
        let parsedHoursCache = {};

        const categoryMap = [
            { keywords: ['ç‡’è‚‰', 'çƒ¤è‚‰', 'ä¸²ç‡’', 'å±…é…’å±‹'], color: '#e53e3e', icon: 'fa-fire', text: 'ç‡’è‚‰æ–™ç†' },
            { keywords: ['ç«é‹', 'é‹ç‰©', 'æ¶®æ¶®é‹', 'éº»è¾£'], color: '#dd6b20', icon: 'fa-utensils', text: 'ç²¾ç·»é‹ç‰©' },
            { keywords: ['å’–å•¡', 'ç”œé»', 'ä¸‹åˆèŒ¶', 'è›‹ç³•', 'cafe'], color: '#d53f8c', icon: 'fa-mug-hot', text: 'ç”œé»å’–å•¡' },
            { keywords: ['æ‹‰éºµ', 'æ—¥å¼', 'å£½å¸', 'ä¸¼', 'ç”Ÿé­šç‰‡'], color: '#3182ce', icon: 'fa-fish', text: 'æ—¥å¼æ–™ç†' },
            { keywords: ['æ³°å¼', 'è¶Šå¼', 'æ±å—äº', 'å—æ´‹'], color: '#38a169', icon: 'fa-leaf', text: 'ç•°åœ‹é¢¨å‘³' },
            { keywords: ['å°åƒ', 'éºµ', 'é£¯', 'ä¾¿ç•¶', 'å‚³çµ±'], color: '#d69e2e', icon: 'fa-bowl-food', text: 'åœ¨åœ°å°åƒ' },
            { keywords: ['ç¾©å¼', 'ç¾©å¤§åˆ©', 'æŠ«è–©', 'pasta'], color: '#e53e3e', icon: 'fa-pizza-slice', text: 'ç¾©å¼æ–™ç†' },
            { keywords: ['ç¾å¼', 'æ¼¢å ¡', 'ç‰›æ’'], color: '#2b6cb0', icon: 'fa-hamburger', text: 'ç¾å¼æ–™ç†' },
            { keywords: ['æ—©åˆé¤', 'æ—©é¤'], color: '#ecc94b', icon: 'fa-egg', text: 'æ—©åˆé¤' },
            { keywords: ['é…’å§', 'é¤é…’é¤¨', 'bistro'], color: '#805ad5', icon: 'fa-wine-glass', text: 'é¤é…’é¤¨' }
        ];

        try { appState.myFavorites = JSON.parse(localStorage.getItem('myFoodFavorites')) || []; } catch (e) {}

        init();

        function init() {
            log("ğŸš€ ç³»çµ±å•Ÿå‹•...");
            // âœ¨ åˆå§‹åŒ–æ™‚å¼·åˆ¶æ¸…ç©ºç€è¦½å™¨å¿«å–çš„é¸é …
            document.getElementById('searchInput').value = "";
            document.getElementById('michelinSelect').value = "all";
            document.getElementById('openFilter').checked = false;
            document.getElementById('rangeSelect').value = "99999";
            document.getElementById('sortSelect').value = "dist";

            window.onscroll = function() {
                const btn = document.getElementById('backToTop');
                if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) btn.style.display = "flex";
                else btn.style.display = "none";
            };

            const cachedData = localStorage.getItem('foodMapData');
            const cachedTime = localStorage.getItem('foodMapData_ts');
            const now = Date.now();

            if (cachedData && cachedTime && (now - cachedTime < 3600000)) { 
                log("âš¡ è®€å–å¿«å–");
                // âœ¨ ä¿®æ­£ï¼šè®€å–å¿«å–å¾Œï¼Œä¹Ÿè¦è¨­ç‚º true æ‰èƒ½é¦¬ä¸Šçœ‹åˆ°ç•«é¢
                processData(JSON.parse(cachedData), true); 
                fetchDataSmart(true); 
            } else {
                document.getElementById('loadingMsg').style.display = "block";
                document.getElementById('loadingMsg').innerText = "â³ æ­£åœ¨ä¸‹è¼‰è³‡æ–™...";
                document.getElementById('loadingBar').style.display = 'block';
                fetchDataSmart(false);
            }

            let timeout = null;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    appState.currentKeyword = e.target.value.toLowerCase();
                    appState.isShowingFavs = false; updateUIState(); applyFiltersAndSort();
                }, 300);
            });
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        function fetchDataSmart(isBackground) {
            const apiPromise = new Promise((resolve, reject) => {
                if (scriptUrl && scriptUrl.includes('script.google.com') && !scriptUrl.includes('YOUR_GAS')) {
                    if(!isBackground) log("ğŸ“¡ é€£ç·šè‡³ GAS...");
                    fetch(scriptUrl)
                        .then(r => r.json())
                        .then(data => resolve(data))
                        .catch(e => reject(e));
                } else {
                    reject("No API URL");
                }
            });

            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 3000));

            Promise.race([apiPromise, timeoutPromise])
                .then(data => {
                    log("âœ… API æˆåŠŸ");
                    localStorage.setItem('foodMapData', JSON.stringify(data));
                    localStorage.setItem('foodMapData_ts', Date.now());
                    processData(data, true);
                    finishLoading();
                })
                .catch(e => {
                    if(!isBackground) log("ğŸ“¡ åˆ‡æ›è‡³ CSV æ¨¡å¼...");
                    tryFetchCSV(0, isBackground);
                });
        }

        function tryFetchCSV(proxyIndex, isBackground) {
            if (proxyIndex >= proxyList.length) {
                if(!isBackground) document.getElementById('loadingMsg').innerHTML = `<div class="error-msg">âš ï¸ é€£ç·šå¤±æ•—</div>`;
                return;
            }
            const finalUrl = proxyList[proxyIndex] + encodeURIComponent(rawUrl);
            Papa.parse(finalUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data || results.data.length === 0) return tryFetchCSV(proxyIndex + 1, isBackground);
                    log(`âœ… CSV æˆåŠŸ`);
                    localStorage.setItem('foodMapData', JSON.stringify(results.data));
                    localStorage.setItem('foodMapData_ts', Date.now());
                    processData(results.data, true);
                    finishLoading();
                },
                error: () => tryFetchCSV(proxyIndex + 1, isBackground)
            });
        }

        function finishLoading() {
            document.getElementById('loadingBar').style.display = 'none';
            document.getElementById('loadingMsg').style.display = 'none';
        }

        function processData(data, refreshUI) {
            try {
                parsedHoursCache = {};
                
                appState.allData = data.filter(item => item.name).map(item => {
                    const newItem = {};
                    Object.keys(item).forEach(key => {
                        const cleanKey = key ? key.toLowerCase().trim().replace('_', '') : "unknown";
                        newItem[cleanKey] = item[key]?item[key]:"";
                    });
                    if(!newItem.city) newItem.city = "æœªåˆ†é¡";
                    newItem.id = `${newItem.city}-${newItem.name || Math.random()}`;
                    newItem.lat = parseFloat(newItem.lat);
                    newItem.lng = parseFloat(newItem.lng);
                    if (isNaN(newItem.lat) || isNaN(newItem.lng)) { newItem.lat = null; newItem.lng = null; }
                    newItem.rating = parseFloat(newItem.rating || newItem.googlerating || 0);
                    newItem.image = newItem.image || ""; 
                    newItem.distance = null;
                    newItem.type = newItem.type ? newItem.type.trim() : "å…¶ä»–";
                    newItem.hours = newItem.hours ? String(newItem.hours) : ""; 
                    newItem.michelinType = newItem.michelin ? newItem.michelin.toString().trim().toLowerCase() : "";
                    newItem.booking = newItem.booking || "";
                    
                    if (newItem.hours) preParseHours(newItem.hours);
                    return newItem;
                });
                
                if(refreshUI) {
                    renderTypeButtons(); 
                    renderCityButtons();
                    applyFiltersAndSort();
                }
            } catch(e) { log("âŒ Error: " + e.message); }
        }

        function preParseHours(hoursStr) {
            if (parsedHoursCache[hoursStr]) return;
            let cleanStr = hoursStr.replace(/æ™šé¤|åˆé¤|æœ€å¾Œé»é¤|last order|ä¼‘æ¯|å…¬ä¼‘/gi, "");
            cleanStr = cleanStr.replace(/ï¼š/g, ":").replace(/ï½|to/g, "-").replace(/\./g, ":"); 
            cleanStr = cleanStr.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248));
            const timeSegments = [];
            const timeMatches = cleanStr.match(/(\d{1,2}:\d{2})\s*(AM|PM)?/gi);
            if (timeMatches && timeMatches.length >= 2) {
                for (let i = 0; i < timeMatches.length - 1; i += 2) {
                    const startStr = timeMatches[i]; const endStr = timeMatches[i+1];
                    if (!startStr.includes(':') || !endStr.includes(':')) continue;
                    let start = parseTime(startStr); let end = parseTime(endStr);
                    if (end < start) end += 1440; 
                    timeSegments.push([start, end]);
                }
            }
            parsedHoursCache[hoursStr] = timeSegments;
        }

        function checkIsOpen(hoursStr) {
            if (!hoursStr || typeof hoursStr !== 'string') return false;
            const now = new Date(); const dayOfWeek = now.getDay(); 
            const dayMap = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            if (hoursStr.includes(dayMap[dayOfWeek] + "å…¬ä¼‘") || hoursStr.includes(dayMap[dayOfWeek] + "ä¼‘æ¯")) return false;
            if (hoursStr.toUpperCase().includes('24H') || hoursStr.includes('24å°æ™‚')) return true;
            const segments = parsedHoursCache[hoursStr];
            if (!segments || segments.length === 0) return false;
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            for (let i = 0; i < segments.length; i++) {
                const [start, end] = segments[i];
                let checkTime = currentMinutes;
                if (checkTime < start && end >= 1440) checkTime += 1440;
                if (checkTime >= start && checkTime <= end) return true;
            }
            return false;
        }

        function parseTime(t) { 
            if(!t) return 0;
            let isPM = /PM|pm|ä¸‹åˆ|æ™š/.test(t);
            let isAM = /AM|am|ä¸Šåˆ|æ—©/.test(t);
            let clean = t.replace(/[^0-9:]/g, ''); 
            let parts = clean.split(':');
            if (parts.length < 2) return 0;
            let h = parseInt(parts[0]);
            let m = parseInt(parts[1]);
            if (isPM && h < 12) h += 12;
            if (isAM && h === 12) h = 0;
            return h * 60 + m; 
        }

        // âœ¨ é‡ç½®åŠŸèƒ½ä¿®å¾©ï¼šå¼·åˆ¶è§¸ç™¼ applyFiltersAndSort
        function resetAllFilters() {
            appState.isShowingFavs = false;
            appState.isShowingNearby = false;
            appState.isOpenOnly = false;
            appState.currentKeyword = "";
            appState.currentType = "å…¨éƒ¨";
            appState.currentCity = "å…¨å°";
            appState.currentDistrict = "å…¨éƒ¨";

            document.getElementById('searchInput').value = "";
            document.getElementById('michelinSelect').value = "all";
            document.getElementById('openFilter').checked = false;
            document.getElementById('rangeSelect').value = "99999";
            
            updateUIState();
            renderTypeButtons(); 
            renderCityButtons(); 
            
            // âœ¨ é—œéµï¼šå¼·åˆ¶é‡æ–°æ¸²æŸ“åˆ—è¡¨
            applyFiltersAndSort();
            
            showToast("ğŸ”„ æ‰€æœ‰ç¯©é¸å·²é‡ç½®");
        }

        // --- ä»¥ä¸‹ UI å‡½å¼ç¶­æŒ v25 ---
        function applyFiltersAndSort() {
            let results = [...appState.allData];
            if (appState.isShowingFavs) { results = results.filter(i => appState.myFavorites.includes(i.id)); } else { if (appState.currentKeyword) { results = results.filter(item => item.name.toLowerCase().includes(appState.currentKeyword)); } else { if (appState.currentCity !== "å…¨å°") { results = results.filter(i => i.city === appState.currentCity); if (appState.currentDistrict !== "å…¨éƒ¨") { results = results.filter(i => i.district === appState.currentDistrict); } } } if (appState.currentType !== "å…¨éƒ¨") results = results.filter(i => i.type === appState.currentType); }
            if (appState.isOpenOnly) { results = results.filter(item => { try { return checkIsOpen(item.hours) === true; } catch (e) { return false; } }); }
            const michelinMode = document.getElementById('michelinSelect').value;
            if (michelinMode !== 'all') { if (michelinMode === 'any') results = results.filter(i => i.michelinType !== ""); else results = results.filter(i => i.michelinType === michelinMode); }
            if (appState.isShowingNearby) { const limit = parseFloat(document.getElementById('rangeSelect').value); results = results.filter(item => item.distance <= limit); }
            const sortMode = document.getElementById('sortSelect').value;
            results.sort((a, b) => sortMode === 'rating' ? (b.rating || -1) - (a.rating || -1) : (a.distance || 99999) - (b.distance || 99999));
            appState.filteredData = results; appState.displayedCount = 0; document.getElementById('foodContainer').innerHTML = '';
            if (appState.viewMode === 'list') loadMore(); else renderMap(results);
        }
        function loadMore() { const container = document.getElementById('foodContainer'); const total = appState.filteredData.length; const start = appState.displayedCount; const end = Math.min(start + BATCH_SIZE, total); if (start >= total) { if (total === 0) container.innerHTML = '<p style="text-align:center;width:100%;color:#888;padding:40px;grid-column:1/-1;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„åº—å®¶</p>'; document.getElementById('loadMoreBtn').style.display = 'none'; return; } const fragment = document.createDocumentFragment(); for (let i = start; i < end; i++) { fragment.appendChild(createCard(appState.filteredData[i])); } container.appendChild(fragment); appState.displayedCount = end; const loadMoreBtn = document.getElementById('loadMoreBtn'); if (appState.displayedCount < total) { loadMoreBtn.style.display = 'inline-block'; loadMoreBtn.innerText = `ğŸ‘‡ è¼‰å…¥æ›´å¤š (${appState.displayedCount} / ${total})`; } else { loadMoreBtn.style.display = 'none'; } }
        function createCard(item) { const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address||item.name)}`; const displayPhone = formatPhoneNumber(item.phone); const rawPhone = item.phone ? item.phone.replace(/\D/g, '') : ""; let isOpen = checkIsOpen(item.hours); let statusBadge = isOpen === true ? '<span class="status-badge status-open">ğŸŸ¢ ç‡Ÿæ¥­ä¸­</span>' : (isOpen === false ? '<span class="status-badge status-closed">âšª ä¼‘æ¯ä¸­</span>' : ''); let ratingHtml = item.rating > 0 ? `<span class="rating-badge"><i class="fas fa-star"></i> ${item.rating.toFixed(1)}</span>` : ''; let distHtml = (appState.isShowingNearby && item.distance < 9000) ? `<span class="dist-badge"><i class="fas fa-route"></i> ${formatDistance(item.distance)}</span>` : ''; const isFav = appState.myFavorites.includes(item.id); const card = document.createElement('div'); card.className = 'food-card'; let imageContent = ''; if (item.image) { imageContent = `<img src="${item.image}" alt="${item.name}" loading="lazy">`; } else { const cat = getCategoryStyle(item.type); imageContent = `<div class="card-placeholder" style="background:${cat.color}"><i class="fas ${cat.icon}"></i><span>${cat.text}</span></div>`; } const michelinBadge = getMichelinBadge(item.michelinType); let buttonsHtml = ''; if (item.booking) buttonsHtml += `<a href="${item.booking}" target="_blank" class="btn-booking"><i class="fas fa-calendar-check"></i> ç·šä¸Šè¨‚ä½</a>`; buttonsHtml += `<a href="${mapLink}" target="_blank" class="btn-nav"><i class="fas fa-map-marker-alt" style="margin-right:5px;"></i> å°èˆª</a>`; if (item.website) buttonsHtml += `<a href="${item.website}" target="_blank" class="btn-icon bg-web"><i class="fas fa-globe"></i></a>`; if (item.fb) buttonsHtml += `<a href="${item.fb}" target="_blank" class="btn-icon bg-fb"><i class="fab fa-facebook-f"></i></a>`; if (item.ig) buttonsHtml += `<a href="${item.ig}" target="_blank" class="btn-icon bg-ig"><i class="fab fa-instagram"></i></a>`; if (item.youtube) buttonsHtml += `<a href="${item.youtube}" target="_blank" class="btn-icon bg-yt"><i class="fab fa-youtube"></i></a>`; card.innerHTML = ` <div class="card-image-box"> ${michelinBadge} ${imageContent} <div class="card-actions"> <button class="action-btn share-btn" onclick="shareStore('${item.name}', '${item.address}', '${item.rating}', '${mapLink}')"><i class="fas fa-share-alt"></i></button> <button class="action-btn btn-love ${isFav?'is-fav':''}" onclick="toggleHeart('${item.id}', this)"><i class="fas fa-heart"></i></button> </div> </div> <div class="card-content"> <div class="card-top-row"> <div class="meta-group"><span class="meta-tag" onclick="filterByType('${item.type}')">${item.city} ${item.district}</span><span class="meta-tag" onclick="filterByType('${item.type}')">${item.type}</span></div> ${statusBadge} </div> <h3 class="card-title"><span>${item.name}</span>${ratingHtml}${distHtml}</h3> <div class="info-row"><i class="far fa-clock info-icon"></i><span class="hours-text">${item.hours}</span></div> <div class="info-row"><i class="fas fa-phone-alt info-icon"></i><a href="tel:${rawPhone}" style="color:#333;text-decoration:none">${displayPhone}</a></div> <div class="info-row"><i class="fas fa-map-marker-alt info-icon"></i><span>${item.address}</span></div> ${item.note ? `<p class="note">${item.note}</p>` : ''} <div class="btn-group">${buttonsHtml}</div> </div> `; return card; }
        function getMichelinBadge(type) { if (!type) return ""; if (type === '3') return `<div class="michelin-badge bg-star"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> ç±³å…¶æ—ä¸‰æ˜Ÿ</div>`; if (type === '2') return `<div class="michelin-badge bg-star"><i class="fas fa-star"></i><i class="fas fa-star"></i> ç±³å…¶æ—äºŒæ˜Ÿ</div>`; if (type === '1') return `<div class="michelin-badge bg-star"><i class="fas fa-star"></i> ç±³å…¶æ—ä¸€æ˜Ÿ</div>`; if (type === 'bib') return `<div class="michelin-badge bg-bib"><i class="fas fa-smile-beam"></i> å¿…æ¯”ç™»æ¨è–¦</div>`; if (type === 'selected') return `<div class="michelin-badge bg-selected"><i class="fas fa-utensils"></i> å…¥é¸é¤å»³</div>`; return ""; }
        function getCategoryStyle(typeStr) { const t = (typeStr || "").toLowerCase(); let match = categoryMap.find(cat => cat.keywords.some(k => t.includes(k))); if (!match) return { color: '#a0aec0', icon: 'fa-utensils', text: 'ç²¾é¸ç¾é£Ÿ' }; return match; }
        function renderCityButtons() { const cities = [...new Set(appState.allData.map(item => item.city))]; const container = document.getElementById('cityButtons'); container.innerHTML = ''; const allBtn = document.createElement('button'); allBtn.className = 'btn city-btn'; allBtn.innerText = "å…¨å°"; if (appState.currentCity === "å…¨å°") allBtn.classList.add('active'); allBtn.onclick = () => { appState.currentCity = "å…¨å°"; appState.currentDistrict = "å…¨éƒ¨"; document.getElementById('districtSection').style.display = 'none'; document.querySelectorAll('.city-btn').forEach(b => b.classList.remove('active')); allBtn.classList.add('active'); applyFiltersAndSort(); }; container.appendChild(allBtn); cities.forEach(city => { const btn = document.createElement('button'); btn.className = 'btn city-btn'; btn.innerText = city; if (city === appState.currentCity) btn.classList.add('active'); btn.onclick = () => { appState.currentCity = city; appState.currentDistrict = "å…¨éƒ¨"; appState.currentKeyword = ""; document.getElementById('searchInput').value=""; filterByCity(btn); }; container.appendChild(btn); }); }
        function filterByCity(btn) { document.querySelectorAll('.city-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); document.getElementById('districtSection').style.display = 'block'; const cityData = appState.allData.filter(i => i.city === appState.currentCity); const districts = ["å…¨éƒ¨", ...new Set(cityData.map(i => i.district))]; const dc = document.getElementById('districtButtons'); dc.innerHTML = ''; districts.forEach(d => { const btn = document.createElement('button'); btn.className = 'btn district-btn'; btn.innerText = d; if(d === appState.currentDistrict) btn.classList.add('active'); btn.onclick = () => { appState.currentDistrict = d; document.querySelectorAll('.district-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); applyFiltersAndSort(); }; dc.appendChild(btn); }); applyFiltersAndSort(); }
        function renderTypeButtons() { const types = ["å…¨éƒ¨", ...new Set(appState.allData.map(i => i.type).filter(t => t))]; const container = document.getElementById('typeButtons'); container.innerHTML = ''; types.forEach(type => { const btn = document.createElement('button'); btn.className = 'type-btn'; if (type !== "å…¨éƒ¨") { const style = getCategoryStyle(type); btn.innerHTML = `<i class="fas ${style.icon}" style="color:${style.color}"></i> ${type}`; } else { btn.innerText = "å…¨éƒ¨"; } if(type === appState.currentType) btn.classList.add('active'); btn.onclick = () => filterByType(type); container.appendChild(btn); }); }
        function filterByType(type) { appState.currentType = type; renderTypeButtons(); applyFiltersAndSort(); }
        function toggleFavFilter() { appState.isShowingFavs = !appState.isShowingFavs; appState.isShowingNearby = false; updateUIState(); applyFiltersAndSort(); }
        function toggleHeart(id, btn) { const idx = appState.myFavorites.indexOf(id); if(idx===-1) { appState.myFavorites.push(id); btn.classList.add('is-fav'); } else { appState.myFavorites.splice(idx,1); btn.classList.remove('is-fav'); if(appState.isShowingFavs) applyFiltersAndSort(); } localStorage.setItem('myFoodFavorites', JSON.stringify(appState.myFavorites)); }
        function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); }
        function formatDistance(km) { if (km >= 9999) return ""; if (km < 1) return (km * 1000).toFixed(0) + " m"; return km.toFixed(1) + " km"; }
        function formatPhoneNumber(p) { if (!p) return "ç„¡"; let c = p.replace(/\D/g, ''); if (c.length === 10 && c.startsWith('09')) return c.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3'); if (c.length === 10 && c.startsWith('0')) return c.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3'); return p; }
        function resetToDefaultView() { appState.isShowingNearby = false; updateUIState(); applyFiltersAndSort(); }
        function shareStore(name, address, rating, url) { const text = `ã€${name}ã€‘\nâ­ è©•åˆ†ï¼š${rating || 'æš«ç„¡'}\nğŸ  åœ°å€ï¼š${address}\nğŸ“ åœ°åœ–ï¼š${url}`; if (navigator.share) { navigator.share({ title: name, text: text, url: url }).catch((error) => console.log('åˆ†äº«å–æ¶ˆ', error)); } else { navigator.clipboard.writeText(text).then(() => { showToast("âœ… åº—å®¶è³‡è¨Šå·²è¤‡è£½ï¼"); }); } }
        function showToast(msg) { const toast = document.getElementById("toast"); toast.innerText = msg; toast.className = "show"; setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000); }
        function toggleViewMode() { const btn = document.getElementById('viewBtn'); const listDiv = document.getElementById('foodContainer'); const mapDiv = document.getElementById('mapContainer'); const loadMoreBtn = document.getElementById('loadMoreBtn'); if (appState.viewMode === 'list') { appState.viewMode = 'map'; btn.innerHTML = '<i class="fas fa-list"></i> åˆ—è¡¨'; listDiv.style.display = 'none'; loadMoreBtn.style.display = 'none'; mapDiv.style.display = 'block'; setTimeout(() => { if(!map) initMap(); map.invalidateSize(); applyFiltersAndSort(); }, 100); } else { appState.viewMode = 'list'; btn.innerHTML = '<i class="fas fa-map-marked-alt"></i> åœ°åœ–'; listDiv.style.display = 'grid'; mapDiv.style.display = 'none'; applyFiltersAndSort(); } }
        function updateUIState() { const favBtn = document.getElementById('favFilterBtn'); const gpsBtn = document.getElementById('gpsBtn'); const filterSection = document.getElementById('filterSection'); gpsBtn.classList.remove('loading'); if (appState.isShowingFavs) { favBtn.classList.add('active'); favBtn.innerText = "ğŸ”™ å›åˆ—è¡¨"; } else { favBtn.classList.remove('active'); favBtn.innerText = "â¤ï¸ å£è¢‹"; } if (appState.isShowingNearby) { gpsBtn.classList.add('active'); gpsBtn.innerHTML = '<i class="fas fa-times"></i> æ¸…é™¤å®šä½'; document.getElementById('cityButtons').style.display = 'none'; document.getElementById('districtSection').style.display = 'none'; } else { gpsBtn.classList.remove('active'); gpsBtn.innerHTML = '<i class="fas fa-location-arrow"></i> é™„è¿‘'; document.getElementById('cityButtons').style.display = 'flex'; document.getElementById('districtSection').style.display = (appState.currentCity !== "å…¨å°") ? 'block' : 'none'; } }
        function initMap() { if (map) return; map = L.map('mapContainer').setView([23.9738, 120.9820], 7); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map); markersGroup = L.markerClusterGroup({ showCoverageOnHover: false, zoomToBoundsOnClick: true }).addTo(map); }
        function renderMap(data) { if (!map) initMap(); markersGroup.clearLayers(); const validData = data.filter(d => d.lat && d.lng); if (validData.length === 0) return; const bounds = []; validData.forEach(item => { const marker = L.marker([item.lat, item.lng]); const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address||item.name)}`; let isOpen = checkIsOpen(item.hours); const statusText = isOpen === true ? '<span style="color:green">â— ç‡Ÿæ¥­ä¸­</span>' : (isOpen === false ? '<span style="color:gray">â— ä¼‘æ¯ä¸­</span>' : ''); let title = item.name; if(item.michelinType === '3') title = `â­â­â­ ${item.name}`; else if(item.michelinType === '2') title = `â­â­ ${item.name}`; else if(item.michelinType === '1') title = `â­ ${item.name}`; else if(item.michelinType === 'bib') title = `ğŸ˜‹ ${item.name}`; let bookingBtn = ""; if (item.booking) bookingBtn = `<a href="${item.booking}" target="_blank" class="map-popup-btn" style="background:#ed8936;margin-top:5px;">ğŸ“… ç·šä¸Šè¨‚ä½</a>`; const popupContent = `<div class="map-popup-card"><div class="map-popup-header">${title} <span style="font-size:0.8em">â­ ${item.rating || '-'}</span></div><div class="map-popup-body"><div class="map-popup-info">${statusText}</div><div class="map-popup-info"><i class="fas fa-tag"></i> ${item.type}</div><div class="map-popup-info"><i class="fas fa-map-marker-alt"></i> ${item.address}</div>${bookingBtn}<a href="${mapLink}" target="_blank" class="map-popup-btn">ğŸ“ å°èˆªå»</a></div></div>`; marker.bindPopup(popupContent); markersGroup.addLayer(marker); bounds.push([item.lat, item.lng]); }); if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] }); }
    </script>
</body>
</html>
