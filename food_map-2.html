<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÖ®Âè∞ÁæéÈ£üÂú∞Âúñ (v14.0 ÂÆåÊï¥Ë£úÂÆåÁâà)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        /* --- CSS Ê®£ÂºèÂçÄ --- */
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; color: #222; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2.2em; letter-spacing: 1px; font-weight: 900; }
        .subtitle { color: #555; font-size: 1.1em; margin-bottom: 25px; }
        
        /* ÈÄ≤Â∫¶Ê¢ù */
        .loading-bar { width: 100%; background: #e2e8f0; height: 4px; position: fixed; top: 0; left: 0; z-index: 9999; display: none; }
        .loading-bar .bar { height: 100%; background: #38b2ac; animation: load 1.5s infinite ease-in-out; width: 50%; }
        @keyframes load { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

        .controls-wrapper { max-width: 900px; margin: 0 auto 20px auto; }
        .controls-row-1 { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 12px; margin-bottom: 12px; }
        
        .search-box { flex: 2; padding: 12px 20px; border: 2px solid #ccc; min-width: 200px; border-radius: 30px; font-size: 18px; outline: none; transition: 0.3s; }
        .search-box:focus { border-color: #38b2ac; box-shadow: 0 0 8px rgba(56, 178, 172, 0.3); }

        .select-pill {
            min-width: 130px; padding: 0 20px; border: 2px solid #ccc; border-radius: 30px; height: 50px;
            font-size: 16px; outline: none; background: white; cursor: pointer; color: #333; font-weight: bold;
        }

        .toggle-wrapper {
            display: flex; align-items: center; background: white; border: 2px solid #ccc; 
            padding: 5px 15px 5px 5px; border-radius: 30px; height: 50px; box-sizing: border-box; cursor: pointer;
            user-select: none; transition: 0.2s;
        }
        .toggle-wrapper:hover { border-color: #38b2ac; }
        .toggle-switch { position: relative; width: 44px; height: 26px; margin-right: 10px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input:checked + .slider { background-color: #38b2ac; }
        input:checked + .slider:before { transform: translateX(18px); }
        .toggle-label { font-size: 16px; font-weight: bold; color: #555; }
        input:checked ~ .toggle-label { color: #38b2ac; }

        .controls-row-2 { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .btn-pill { padding: 0 25px; height: 50px; border-radius: 30px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; border: none; font-size: 16px; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-fav { background-color: #fff; border: 2px solid #e53e3e; color: #e53e3e; }
        .btn-fav:hover, .btn-fav.active { background-color: #e53e3e; color: white; }
        .btn-gps { background-color: #fff; border: 2px solid #38b2ac; color: #38b2ac; }
        .btn-gps:hover, .btn-gps.active { background-color: #38b2ac; color: white; }
        .btn-gps.loading { opacity: 0.7; cursor: wait; pointer-events: none; }
        
        .btn-view { background-color: #2d3748; color: white; border: 2px solid #2d3748; }
        .btn-view:hover { background-color: #4a5568; }

        .loading { text-align: center; color: #38b2ac; font-weight: bold; padding: 20px; font-size: 1.2em; display: none; }
        .error-msg { color: #e53e3e; background: #fff5f5; padding: 15px; border-radius: 10px; border: 1px solid #fc8181; display: inline-block; text-align: left; }

        .filter-section { max-width: 1000px; margin: 0 auto 20px auto; text-align: center; }
        .btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .label { font-size: 16px; color: #666; margin-bottom: 10px; display: block; font-weight: bold; }
        
        .btn { border: none; padding: 8px 18px; border-radius: 25px; cursor: pointer; font-size: 15px; transition: 0.2s; font-weight: 500; }
        .city-btn { background-color: #e2e8f0; color: #4a5568; }
        .city-btn.active { background-color: #2d3748; color: white; transform: scale(1.05); box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
        .district-btn { background-color: #e6fffa; color: #2c7a7b; border: 1px solid #b2f5ea; }
        .district-btn.active { background-color: #38b2ac; color: white; border-color: #38b2ac; }

        .type-btn { 
            background-color: white; border: 2px solid #eee; color: #444; 
            padding: 8px 16px; border-radius: 25px; cursor: pointer; font-size: 15px; 
            transition: 0.2s; display: flex; align-items: center; gap: 6px; font-weight: bold;
        }
        .type-btn:hover { background-color: #f7fafc; transform: translateY(-2px); border-color: #cbd5e0; }
        .type-btn.active { background-color: #4a5568; color: white; border-color: #4a5568; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scale(1.05); }
        .type-btn i { font-size: 1.2em; }

        .food-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; }
        
        #mapContainer { display: none; width: 100%; height: 75vh; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 2px solid #fff; z-index: 1; }

        .food-card { background: white; border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; animation: fadeIn 0.4s; position: relative; }
        
        .card-image-box { width: 100%; height: 200px; position: relative; overflow: hidden; background-color: #f0f0f0; }
        .card-image-box img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .food-card:hover .card-image-box img { transform: scale(1.05); }

        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 5; }
        .action-btn { 
            width: 40px; height: 40px; border-radius: 50%; border: none; 
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            color: white; font-size: 1.2em; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .action-btn:hover { background: rgba(0,0,0,0.7); transform: scale(1.1); }
        .action-btn.is-fav { background: white; color: #ff4757; }
        .action-btn.share-btn:hover { background: white; color: #3182ce; }

        .card-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .card-placeholder i { font-size: 3.5em; margin-bottom: 10px; opacity: 0.95; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
        .card-placeholder span { font-size: 1.4em; font-weight: bold; letter-spacing: 2px; opacity: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        .card-content { padding: 20px; display: flex; flex-direction: column; flex-grow: 1; }
        .card-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
        .meta-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .meta-tag { font-size: 13px; color: #444; background: #edf2f7; padding: 4px 10px; border-radius: 6px; display: inline-block; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .meta-tag:hover { background: #cbd5e0; color: #1a202c; }
        
        .card-title { margin: 5px 0 15px 0; color: #1a202c; font-size: 1.6em; font-weight: 800; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; line-height: 1.3; }
        .rating-badge { font-size: 14px; color: #b7791f; background: #fffbe6; border: 1px solid #f6e05e; padding: 3px 10px; border-radius: 15px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; vertical-align: middle; }
        .dist-badge { font-size: 14px; color: #2d3748; background: #e2e8f0; padding: 3px 10px; border-radius: 15px; display: inline-flex; align-items: center; gap: 4px; vertical-align: middle; font-weight: bold; }
        
        .status-badge { font-size: 14px; padding: 5px 12px; border-radius: 20px; font-weight: 800; white-space: nowrap; margin-left: auto; letter-spacing: 0.5px; }
        .status-open { background-color: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4; } 
        .status-closed { background-color: #edf2f7; color: #718096; border: 1px solid #cbd5e0; } 

        .info-row { display: flex; align-items: flex-start; margin-bottom: 10px; font-size: 1.05em; color: #333; line-height: 1.5; }
        .info-icon { margin-right: 12px; width: 18px; text-align: center; color: #38b2ac; margin-top: 3px; font-size: 1.1em; }
        .hours-text { color: #e53e3e; font-weight: bold; }
        .note { background: #f8f9fa; color: #555; padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 0.95em; line-height: 1.6; }
        
        .btn-group { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; }
        .btn-nav { flex-grow: 1; height: 44px; background-color: #38b2ac; color: white; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-weight: bold; font-size: 1em; transition: 0.2s; box-shadow: 0 3px 6px rgba(56, 178, 172, 0.25); }
        .btn-nav:hover { background-color: #319795; transform: translateY(-2px); }
        .btn-icon { width: 44px; height: 44px; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 1.3em; transition: 0.2s; color: white; border: 1px solid #eee; flex-shrink: 0; }
        .btn-icon:hover { transform: translateY(-2px); filter: brightness(0.95); }
        .bg-web { color: #ed8936; } .bg-fb { color: #1877F2; } .bg-ig { color: #d6249f; } .bg-yt { color: #FF0000; } 
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 30px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; font-size: 17px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }
        
        /* ‚ú® ÂõûÂà∞È†ÇÈÉ®ÊåâÈàï (‰øÆÂæ©) */
        #backToTop {
            position: fixed; bottom: 85px; right: 20px; width: 45px; height: 45px; 
            background: #2c3e50; color: white; border-radius: 50%; border: none; 
            font-size: 1.2em; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            z-index: 999; display: none; align-items: center; justify-content: center; 
            transition: 0.3s; opacity: 0.9;
        }
        #backToTop:hover { transform: translateY(-3px); background: #38b2ac; }

        /* Leaflet Popup */
        .leaflet-popup-content-wrapper { border-radius: 12px; overflow: hidden; padding: 0; }
        .leaflet-popup-content { margin: 0; width: 260px !important; }
        .map-popup-card { font-family: "Microsoft JhengHei"; }
        .map-popup-header { background: #38b2ac; color: white; padding: 10px; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .map-popup-body { padding: 15px; }
        .map-popup-info { margin-bottom: 5px; font-size: 0.95em; color: #444; display: flex; align-items: center; gap: 5px; }
        .map-popup-btn { display: block; text-align: center; background: #2d3748; color: white; padding: 8px; margin-top: 10px; border-radius: 6px; text-decoration: none; font-weight: bold; }

        #debugLog { margin-top: 50px; padding: 15px; background: #2d3748; color: #00ff00; font-family: monospace; border-radius: 8px; font-size: 12px; max-height: 200px; overflow-y: auto; display: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loadingBar" class="loading-bar"><div class="bar"></div></div>

    <header>
        <h1>üáπüáº ÂÖ®Âè∞ÁæéÈ£üÂú∞Âúñ</h1>
        <p class="subtitle">v14.0 ÂÆåÊï¥Ë£úÂÆåÁâà (ÂäüËÉΩÂÖ®Èñã)</p>
        
        <div class="controls-wrapper">
            <div class="controls-row-1">
                <input type="text" id="searchInput" class="search-box" placeholder="üîç ÊêúÂ∞ãÂ∫óÂêç/ÈóúÈçµÂ≠ó...">
                <select id="rangeSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="99999">üìè Ë∑ùÈõ¢: ÂÖ®ÈÉ®</option>
                    <option value="1">1 ÂÖ¨ÈáåÂÖß</option>
                    <option value="3">3 ÂÖ¨ÈáåÂÖß</option>
                    <option value="5" selected>5 ÂÖ¨ÈáåÂÖß</option>
                    <option value="10">10 ÂÖ¨ÈáåÂÖß</option>
                </select>
                <select id="sortSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="dist" selected>üìç Ë∑ùÈõ¢Ëøë‚ÜíÈÅ†</option>
                    <option value="rating">‚≠ê Ë©ïÂàÜÈ´ò‚Üí‰Ωé</option>
                </select>
                <label class="toggle-wrapper">
                    <div class="toggle-switch">
                        <input type="checkbox" id="openFilter" onchange="toggleOpenFilter()">
                        <span class="slider"></span>
                    </div>
                    <span class="toggle-label">Âè™È°ØÁ§∫ÁáüÊ•≠‰∏≠</span>
                </label>
            </div>

            <div class="controls-row-2">
                <button id="gpsBtn" class="btn-pill btn-gps" onclick="findNearby()">
                    <i class="fas fa-location-arrow"></i> ÈôÑËøëÁæéÈ£ü
                </button>
                <button id="favFilterBtn" class="btn-pill btn-fav" onclick="toggleFavFilter()">
                    ‚ù§Ô∏è Âè£Ë¢ãÂêçÂñÆ
                </button>
                <button id="viewBtn" class="btn-pill btn-view" onclick="toggleViewMode()">
                    <i class="fas fa-map-marked-alt"></i> ÂàáÊèõÂú∞Âúñ
                </button>
            </div>
        </div>
    </header>

    <div id="loadingMsg" class="loading"></div>
    
    <div class="filter-section" id="filterSection">
        <span class="label">1. ÁæéÈ£üÈ°ûÂà• (ÂèØÂø´ÈÄüÁØ©ÈÅ∏)</span>
        <div id="typeButtons" class="btn-container"></div>
        <span class="label">2. ÈÅ∏ÊìáÁ∏£Â∏Ç</span>
        <div id="cityButtons" class="btn-container"></div>
        <span class="label">3. ÈÅ∏ÊìáÂú∞ÂçÄ</span>
        <div id="districtButtons" class="btn-container"></div>
    </div>
    
    <div class="food-list" id="foodContainer"></div>
    <div id="mapContainer"></div>
    
    <div id="debugLog"><strong>System Log:</strong><br></div>
    <div id="toast"></div>
    
    <button id="backToTop" onclick="scrollToTop()" title="ÂõûÂà∞È†ÇÈÉ®"><i class="fas fa-arrow-up"></i></button>

    <script>
        function log(msg) {
            console.log(msg);
            const debugDiv = document.getElementById('debugLog');
            if(debugDiv.style.display !== 'block') debugDiv.style.display = 'block';
            debugDiv.innerHTML += `> ${msg}<br>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        window.onerror = function(msg, src, l, c, err) { console.error(msg); };
        
        const sheetID = '2PACX-1vRJXAD8XnJT4MfBoaSSCpByuNcUVwlXTCL702vtUBDsg8aZ__v-_yxXVRVQntuqaJY3eecAwq7qZDIb';
        const rawUrl = `https://docs.google.com/spreadsheets/d/e/${sheetID}/pub?output=csv&cache_bust=${Date.now()}`;
        const proxyList = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url=', 'https://api.codetabs.com/v1/proxy?quest='];

        let appState = { 
            allData: [], currentCity: "", currentDistrict: "ÂÖ®ÈÉ®", currentType: "ÂÖ®ÈÉ®", currentKeyword: "", 
            isShowingFavs: false, isShowingNearby: false, isOpenOnly: false, myFavorites: [], viewMode: 'list' 
        };
        
        let map = null;
        let markersGroup = null;

        const categoryMap = [
            { keywords: ['ÁáíËÇâ', 'ÁÉ§ËÇâ', '‰∏≤Ááí', 'Â±ÖÈÖíÂ±ã'], color: '#e53e3e', icon: 'fa-fire', text: 'ÁáíËÇâÊñôÁêÜ' },
            { keywords: ['ÁÅ´Èçã', 'ÈçãÁâ©', 'Ê∂ÆÊ∂ÆÈçã', 'È∫ªËæ£'], color: '#dd6b20', icon: 'fa-utensils', text: 'Á≤æÁ∑ªÈçãÁâ©' },
            { keywords: ['ÂíñÂï°', 'ÁîúÈªû', '‰∏ãÂçàËå∂', 'ËõãÁ≥ï', 'cafe'], color: '#d53f8c', icon: 'fa-mug-hot', text: 'ÁîúÈªûÂíñÂï°' },
            { keywords: ['ÊãâÈ∫µ', 'Êó•Âºè', 'Â£ΩÂè∏', '‰∏º', 'ÁîüÈ≠öÁâá'], color: '#3182ce', icon: 'fa-fish', text: 'Êó•ÂºèÊñôÁêÜ' },
            { keywords: ['Ê≥∞Âºè', 'Ë∂äÂºè', 'Êù±Âçó‰∫û', 'ÂçóÊ¥ã'], color: '#38a169', icon: 'fa-leaf', text: 'Áï∞ÂúãÈ¢®Âë≥' },
            { keywords: ['Â∞èÂêÉ', 'È∫µ', 'È£Ø', '‰æøÁï∂', 'ÂÇ≥Áµ±'], color: '#d69e2e', icon: 'fa-bowl-food', text: 'Âú®Âú∞Â∞èÂêÉ' },
            { keywords: ['Áæ©Âºè', 'Áæ©Â§ßÂà©', 'Êä´Ëñ©', 'pasta'], color: '#e53e3e', icon: 'fa-pizza-slice', text: 'Áæ©ÂºèÊñôÁêÜ' },
            { keywords: ['ÁæéÂºè', 'Êº¢Â†°', 'ÁâõÊéí'], color: '#2b6cb0', icon: 'fa-hamburger', text: 'ÁæéÂºèÊñôÁêÜ' },
            { keywords: ['Êó©ÂçàÈ§ê', 'Êó©È§ê'], color: '#ecc94b', icon: 'fa-egg', text: 'Êó©ÂçàÈ§ê' },
            { keywords: ['ÈÖíÂêß', 'È§êÈÖíÈ§®', 'bistro'], color: '#805ad5', icon: 'fa-wine-glass', text: 'È§êÈÖíÈ§®' }
        ];

        try { appState.myFavorites = JSON.parse(localStorage.getItem('myFoodFavorites')) || []; } catch (e) {}

        init();

        function init() {
            log("üöÄ Á≥ªÁµ±ÂïüÂãï...");
            
            // Áõ£ËÅΩÊç≤ÂãïÔºåÈ°ØÁ§∫ÂõûÂà∞È†ÇÈÉ®ÊåâÈàï
            window.onscroll = function() {
                const btn = document.getElementById('backToTop');
                if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                    btn.style.display = "flex";
                } else {
                    btn.style.display = "none";
                }
            };

            const cachedData = localStorage.getItem('foodMapData');
            const cachedTime = localStorage.getItem('foodMapData_ts');
            const now = Date.now();

            if (cachedData && cachedTime && (now - cachedTime < 3600000)) { 
                log("‚ö° ËÆÄÂèñÂø´Âèñ (ÁßíÈñã)");
                processData(JSON.parse(cachedData), false); 
                tryFetchData(0, true); 
            } else {
                document.getElementById('loadingMsg').style.display = "block";
                document.getElementById('loadingMsg').innerText = "‚è≥ Ê≠£Âú®‰∏ãËºâË≥áÊñô...";
                document.getElementById('loadingBar').style.display = 'block';
                tryFetchData(0, false);
            }

            let timeout = null;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    appState.currentKeyword = e.target.value.toLowerCase();
                    appState.isShowingFavs = false; updateUIState(); applyFiltersAndSort();
                }, 300);
            });
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        function tryFetchData(proxyIndex, isBackground) {
            if (proxyIndex >= proxyList.length) {
                if(!isBackground) document.getElementById('loadingMsg').innerHTML = `<div class="error-msg">‚ö†Ô∏è ÈÄ£Á∑öÂ§±Êïó</div>`;
                return;
            }
            const finalUrl = proxyList[proxyIndex] + encodeURIComponent(rawUrl);
            if(!isBackground) log(`üì° ÈÄ£Á∑ö‰∏≠ (Á∑öË∑Ø ${proxyIndex + 1})...`);
            
            Papa.parse(finalUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data || results.data.length === 0) return tryFetchData(proxyIndex + 1, isBackground);
                    log(`‚úÖ Êõ¥Êñ∞ÊàêÂäü (Á∑öË∑Ø ${proxyIndex + 1})`);
                    localStorage.setItem('foodMapData', JSON.stringify(results.data));
                    localStorage.setItem('foodMapData_ts', Date.now());
                    processData(results.data, true);
                    document.getElementById('loadingBar').style.display = 'none';
                    document.getElementById('loadingMsg').style.display = 'none';
                },
                error: () => tryFetchData(proxyIndex + 1, isBackground)
            });
        }

        function processData(data, refreshUI) {
            try {
                appState.allData = data.filter(item => item.name).map(item => {
                    const newItem = {};
                    Object.keys(item).forEach(key => {
                        const cleanKey = key ? key.toLowerCase().trim().replace('_', '') : "unknown";
                        newItem[cleanKey] = item[key]?item[key].trim():"";
                    });
                    if(!newItem.city) newItem.city = "Êú™ÂàÜÈ°û";
                    newItem.id = `${newItem.city}-${newItem.name || Math.random()}`;
                    newItem.lat = parseFloat(newItem.lat);
                    newItem.lng = parseFloat(newItem.lng);
                    if (isNaN(newItem.lat) || isNaN(newItem.lng)) { newItem.lat = null; newItem.lng = null; }
                    newItem.rating = parseFloat(newItem.rating || newItem.googlerating || 0);
                    newItem.image = newItem.image || ""; 
                    newItem.distance = null;
                    newItem.type = newItem.type ? newItem.type.trim() : "ÂÖ∂‰ªñ";
                    newItem.hours = newItem.hours ? String(newItem.hours) : ""; 
                    return newItem;
                });
                
                if(refreshUI) {
                    renderTypeButtons(); 
                    renderCityButtons();
                    if(appState.isShowingNearby && navigator.geolocation) findNearby();
                    else applyFiltersAndSort();
                }
            } catch(e) { log("‚ùå Error: " + e.message); }
        }

        function getCategoryStyle(typeStr) {
            const t = (typeStr || "").toLowerCase();
            let match = categoryMap.find(cat => cat.keywords.some(k => t.includes(k)));
            if (!match) return { color: '#a0aec0', icon: 'fa-utensils', text: 'Á≤æÈÅ∏ÁæéÈ£ü' };
            return match;
        }

        function initMap() {
            if (map) return;
            map = L.map('mapContainer').setView([23.9738, 120.9820], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
            markersGroup = L.markerClusterGroup({ showCoverageOnHover: false, zoomToBoundsOnClick: true }).addTo(map);
        }

        function renderMap(data) {
            if (!map) initMap();
            markersGroup.clearLayers();
            const validData = data.filter(d => d.lat && d.lng);
            if (validData.length === 0) return;
            const bounds = [];
            validData.forEach(item => {
                const marker = L.marker([item.lat, item.lng]);
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address||item.name)}`;
                let isOpen = false;
                try { isOpen = checkIsOpen(item.hours); } catch(e) {}
                const statusText = isOpen === true ? '<span style="color:green">‚óè ÁáüÊ•≠‰∏≠</span>' : (isOpen === false ? '<span style="color:gray">‚óè ‰ºëÊÅØ‰∏≠</span>' : '');
                const popupContent = `<div class="map-popup-card"><div class="map-popup-header">${item.name} <span style="font-size:0.8em">‚≠ê ${item.rating || '-'}</span></div><div class="map-popup-body"><div class="map-popup-info">${statusText}</div><div class="map-popup-info"><i class="fas fa-tag"></i> ${item.type}</div><div class="map-popup-info"><i class="fas fa-map-marker-alt"></i> ${item.address}</div><a href="${mapLink}" target="_blank" class="map-popup-btn">üìç Â∞éËà™Âéª</a></div></div>`;
                marker.bindPopup(popupContent);
                markersGroup.addLayer(marker); 
                bounds.push([item.lat, item.lng]);
            });
            if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
        }

        function toggleViewMode() {
            const btn = document.getElementById('viewBtn');
            const listDiv = document.getElementById('foodContainer');
            const mapDiv = document.getElementById('mapContainer');
            if (appState.viewMode === 'list') {
                appState.viewMode = 'map';
                btn.innerHTML = '<i class="fas fa-list"></i> ÂàáÊèõÂàóË°®';
                listDiv.style.display = 'none';
                mapDiv.style.display = 'block';
                setTimeout(() => { if(!map) initMap(); map.invalidateSize(); applyFiltersAndSort(); }, 100);
            } else {
                appState.viewMode = 'list';
                btn.innerHTML = '<i class="fas fa-map-marked-alt"></i> ÂàáÊèõÂú∞Âúñ';
                listDiv.style.display = 'grid';
                mapDiv.style.display = 'none';
            }
        }

        function findNearby() {
            if (appState.isShowingNearby) { resetToDefaultView(); return; }
            const gpsBtn = document.getElementById('gpsBtn');
            gpsBtn.classList.add('loading');
            gpsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÂÆö‰Ωç‰∏≠...';
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') { setTimeout(() => useFakeGPS("Áí∞Â¢ÉÈôêÂà∂"), 500); return; }
            if (!navigator.geolocation) { useFakeGPS("ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥"); return; }
            navigator.geolocation.getCurrentPosition(
                (position) => { log("‚úÖ ÂÆö‰ΩçÊàêÂäü"); calculateDistances(position.coords.latitude, position.coords.longitude); },
                (error) => { log(`‚ö†Ô∏è ÂÆö‰ΩçÂ§±Êïó`); useFakeGPS("ÂÆö‰ΩçÈÄæÊôÇÊàñÂ§±Êïó"); },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function useFakeGPS(reason) { log(`Â∑≤ÂàáÊèõÊ®°Êì¨‰ΩçÁΩÆ (${reason})`); calculateDistances(25.0478, 121.5170); }

        function calculateDistances(userLat, userLng) {
            appState.allData.forEach(item => {
                if (item.lat && item.lng) item.distance = calculateDistance(userLat, userLng, item.lat, item.lng);
                else item.distance = 99999;
            });
            appState.isShowingNearby = true; appState.isShowingFavs = false;
            document.getElementById('sortSelect').value = 'dist'; 
            updateUIState(); applyFiltersAndSort();
        }

        function toggleOpenFilter() {
            const checkbox = document.getElementById('openFilter');
            appState.isOpenOnly = checkbox.checked; 
            log(appState.isOpenOnly ? "üü¢ ÈñãÂïüÔºöÂè™ÁúãÁáüÊ•≠‰∏≠" : "‚ö™ ÈóúÈñâÔºöÈ°ØÁ§∫ÂÖ®ÈÉ®");
            applyFiltersAndSort();
        }

        function applyFiltersAndSort() {
            let results = [...appState.allData];
            if (appState.isShowingFavs) {
                results = results.filter(i => appState.myFavorites.includes(i.id));
            } else {
                if (appState.currentKeyword) {
                    results = results.filter(item => item.name.toLowerCase().includes(appState.currentKeyword));
                } else if (appState.currentCity) {
                    results = results.filter(i => i.city === appState.currentCity);
                    if (appState.currentDistrict !== "ÂÖ®ÈÉ®") results = results.filter(i => i.district === appState.currentDistrict);
                }
                if (appState.currentType !== "ÂÖ®ÈÉ®") results = results.filter(i => i.type === appState.currentType);
            }
            if (appState.isOpenOnly) {
                results = results.filter(item => { try { return checkIsOpen(item.hours) === true; } catch (e) { return false; } });
            }
            if (appState.isShowingNearby) {
                const limit = parseFloat(document.getElementById('rangeSelect').value);
                results = results.filter(item => item.distance <= limit);
            }
            const sortMode = document.getElementById('sortSelect').value;
            results.sort((a, b) => sortMode === 'rating' ? (b.rating || -1) - (a.rating || -1) : (a.distance || 99999) - (b.distance || 99999));
            
            if (appState.viewMode === 'list') renderFood(results);
            else renderMap(results);
        }

        function resetToDefaultView() {
            appState.isShowingNearby = false; appState.isShowingFavs = false; appState.currentKeyword = ""; appState.currentType = "ÂÖ®ÈÉ®";
            document.getElementById('searchInput').value = "";
            updateUIState(); renderTypeButtons(); 
            if (appState.currentCity) filterByCity(appState.currentCity); else renderCityButtons();
        }

        function updateUIState() {
            const favBtn = document.getElementById('favFilterBtn'); const gpsBtn = document.getElementById('gpsBtn'); const filterSection = document.getElementById('filterSection');
            gpsBtn.classList.remove('loading'); 
            if (appState.isShowingFavs) { favBtn.classList.add('active'); favBtn.innerText = "üîô ÂõûÂàóË°®"; } else { favBtn.classList.remove('active'); favBtn.innerText = "‚ù§Ô∏è Âè£Ë¢ã"; }
            if (appState.isShowingNearby) { gpsBtn.classList.add('active'); gpsBtn.innerHTML = '<i class="fas fa-times"></i> Ê∏ÖÈô§ÂÆö‰Ωç'; filterSection.style.display = 'none'; } 
            else { gpsBtn.classList.remove('active'); gpsBtn.innerHTML = '<i class="fas fa-location-arrow"></i> ÈôÑËøëÁæéÈ£ü'; filterSection.style.display = (appState.currentKeyword || appState.isShowingFavs) ? 'none' : 'block'; }
        }

        // --- ‚ú® ÂàÜ‰∫´ÂäüËÉΩ ---
        function shareStore(name, address, rating, url) {
            const text = `„Äê${name}„Äë\n‚≠ê Ë©ïÂàÜÔºö${rating || 'Êö´ÁÑ°'}\nüè† Âú∞ÂùÄÔºö${address}\nüìç Âú∞ÂúñÔºö${url}`;
            // ÂÑ™ÂÖà‰ΩøÁî®ÂéüÁîüÂàÜ‰∫´ (ÈúÄË¶Å HTTPS)
            if (navigator.share) {
                navigator.share({ title: name, text: text, url: url }).catch((error) => console.log('ÂàÜ‰∫´ÂèñÊ∂à', error));
            } else {
                // ÈõªËÖ¶ÊàñÈùû HTTPS ÈôçÁ¥öÁÇ∫Ë§áË£Ω
                navigator.clipboard.writeText(text).then(() => { showToast("‚úÖ Â∫óÂÆ∂Ë≥áË®äÂ∑≤Ë§áË£ΩÔºÅ"); });
            }
        }

        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg; toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function renderFood(data) {
            const container = document.getElementById('foodContainer'); container.innerHTML = '';
            if(data.length === 0) return container.innerHTML = '<p style="text-align:center;width:100%;color:#888;padding:40px;grid-column:1/-1;">Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÂ∫óÂÆ∂</p>';

            const fragment = document.createDocumentFragment();
            data.forEach(item => {
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address||item.name)}`;
                const displayPhone = formatPhoneNumber(item.phone);
                const rawPhone = item.phone ? item.phone.replace(/\D/g, '') : "";
                
                let isOpen = false;
                try { isOpen = checkIsOpen(item.hours); } catch(e) {}

                let statusBadge = isOpen === true ? '<span class="status-badge status-open">üü¢ ÁáüÊ•≠‰∏≠</span>' : (isOpen === false ? '<span class="status-badge status-closed">‚ö™ ‰ºëÊÅØ‰∏≠</span>' : '');
                let ratingHtml = item.rating > 0 ? `<span class="rating-badge"><i class="fas fa-star"></i> ${item.rating.toFixed(1)}</span>` : '';
                let distHtml = (appState.isShowingNearby && item.distance < 9000) ? `<span class="dist-badge"><i class="fas fa-route"></i> ${formatDistance(item.distance)}</span>` : '';
                const isFav = appState.myFavorites.includes(item.id);
                const card = document.createElement('div'); card.className = 'food-card';
                
                let imageContent = '';
                if (item.image) {
                    imageContent = `<img src="${item.image}" alt="${item.name}" loading="lazy">`;
                } else {
                    const cat = getCategoryStyle(item.type);
                    imageContent = `<div class="card-placeholder" style="background:${cat.color}"><i class="fas ${cat.icon}"></i><span>${cat.text}</span></div>`;
                }

                let buttonsHtml = `<a href="${mapLink}" target="_blank" class="btn-nav"><i class="fas fa-map-marker-alt" style="margin-right:5px;"></i> Â∞éËà™</a>`;
                if (item.website) buttonsHtml += `<a href="${item.website}" target="_blank" class="btn-icon bg-web"><i class="fas fa-globe"></i></a>`;
                if (item.fb) buttonsHtml += `<a href="${item.fb}" target="_blank" class="btn-icon bg-fb"><i class="fab fa-facebook-f"></i></a>`;
                if (item.ig) buttonsHtml += `<a href="${item.ig}" target="_blank" class="btn-icon bg-ig"><i class="fab fa-instagram"></i></a>`;
                if (item.youtube) buttonsHtml += `<a href="${item.youtube}" target="_blank" class="btn-icon bg-yt"><i class="fab fa-youtube"></i></a>`;

                card.innerHTML = `
                    <div class="card-image-box">
                        ${imageContent}
                        <div class="card-actions">
                            <button class="action-btn share-btn" onclick="shareStore('${item.name}', '${item.address}', '${item.rating}', '${mapLink}')"><i class="fas fa-share-alt"></i></button>
                            <button class="action-btn btn-love ${isFav?'is-fav':''}" onclick="toggleHeart('${item.id}', this)"><i class="fas fa-heart"></i></button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-top-row">
                            <div class="meta-group"><span class="meta-tag" onclick="filterByType('${item.type}')">${item.city} ${item.district}</span><span class="meta-tag" onclick="filterByType('${item.type}')">${item.type}</span></div>
                            ${statusBadge}
                        </div>
                        <h3 class="card-title"><span>${item.name}</span>${ratingHtml}${distHtml}</h3>
                        <div class="info-row"><i class="far fa-clock info-icon"></i><span class="hours-text">${item.hours}</span></div>
                        <div class="info-row"><i class="fas fa-phone-alt info-icon"></i><a href="tel:${rawPhone}" style="color:#333;text-decoration:none">${displayPhone}</a></div>
                        <div class="info-row"><i class="fas fa-map-marker-alt info-icon"></i><span>${item.address}</span></div>
                        ${item.note ? `<p class="note">${item.note}</p>` : ''}
                        <div class="btn-group">${buttonsHtml}</div>
                    </div>
                `;
                fragment.appendChild(card);
            });
            container.appendChild(fragment);
        }

        function renderCityButtons() {
            const cities = [...new Set(appState.allData.map(item => item.city))];
            const container = document.getElementById('cityButtons'); container.innerHTML = '';
            cities.forEach(city => { 
                const btn = document.createElement('button'); btn.className = 'btn city-btn'; btn.innerText = city; 
                btn.onclick = () => { appState.currentCity = city; appState.currentDistrict = "ÂÖ®ÈÉ®"; appState.currentKeyword = ""; document.getElementById('searchInput').value=""; filterByCity(btn); }; 
                container.appendChild(btn); 
            });
            if(cities.length>0 && !appState.currentCity) { appState.currentCity = cities[0]; filterByCity(container.firstChild); }
        }
        function filterByCity(btn) {
            document.querySelectorAll('.city-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active');
            const cityData = appState.allData.filter(i => i.city === appState.currentCity);
            const districts = ["ÂÖ®ÈÉ®", ...new Set(cityData.map(i => i.district))];
            const dc = document.getElementById('districtButtons'); dc.innerHTML = '';
            districts.forEach(d => { 
                const btn = document.createElement('button'); btn.className = 'btn district-btn'; btn.innerText = d; 
                if(d === appState.currentDistrict) btn.classList.add('active');
                btn.onclick = () => { appState.currentDistrict = d; document.querySelectorAll('.district-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); applyFiltersAndSort(); }; 
                dc.appendChild(btn); 
            });
            applyFiltersAndSort();
        }

        function renderTypeButtons() {
            const types = ["ÂÖ®ÈÉ®", ...new Set(appState.allData.map(i => i.type).filter(t => t))];
            const container = document.getElementById('typeButtons'); container.innerHTML = '';
            types.forEach(type => {
                const btn = document.createElement('button'); btn.className = 'type-btn';
                if (type !== "ÂÖ®ÈÉ®") {
                    const style = getCategoryStyle(type);
                    btn.innerHTML = `<i class="fas ${style.icon}" style="color:${style.color}"></i> ${type}`;
                } else { btn.innerText = "ÂÖ®ÈÉ®"; }
                if(type === appState.currentType) btn.classList.add('active');
                btn.onclick = () => filterByType(type);
                container.appendChild(btn);
            });
        }

        function filterByType(type) { appState.currentType = type; renderTypeButtons(); applyFiltersAndSort(); }
        function toggleFavFilter() { appState.isShowingFavs = !appState.isShowingFavs; appState.isShowingNearby = false; updateUIState(); applyFiltersAndSort(); }
        function toggleHeart(id, btn) {
            const idx = appState.myFavorites.indexOf(id);
            if(idx===-1) { appState.myFavorites.push(id); btn.classList.add('is-fav'); }
            else { appState.myFavorites.splice(idx,1); btn.classList.remove('is-fav'); if(appState.isShowingFavs) applyFiltersAndSort(); }
            localStorage.setItem('myFoodFavorites', JSON.stringify(appState.myFavorites));
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }
        function formatDistance(km) { if (km >= 9999) return ""; if (km < 1) return (km * 1000).toFixed(0) + " m"; return km.toFixed(1) + " km"; }
        function parseTime(t) { 
            try { if (!t || typeof t !== 'string') return 0; const parts = t.split(':'); if (parts.length < 2) return 0; return parseInt(parts[0]) * 60 + parseInt(parts[1]); } catch (e) { return 0; }
        }
        function formatPhoneNumber(p) { if (!p) return "ÁÑ°"; let c = p.replace(/\D/g, ''); if (c.length === 10 && c.startsWith('09')) return c.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3'); if (c.length === 10 && c.startsWith('0')) return c.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3'); return p; }
        
        function checkIsOpen(hoursStr) {
            if (!hoursStr || typeof hoursStr !== 'string') return false;
            let cleanStr = hoursStr.replace(/Ôºö/g, ":").replace(/ÔΩû/g, "-").replace(/~/g, "-").replace(/&/g, ",");
            cleanStr = cleanStr.replace(/\b(\d{4})\b/g, (match) => { return match.slice(0, 2) + ":" + match.slice(2); });
            cleanStr = cleanStr.replace(/\b(\d{3})\b/g, (match) => { return "0" + match.slice(0, 1) + ":" + match.slice(1); });
            const now = new Date(); const dayOfWeek = now.getDay(); const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const dayMap = ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠'];
            if (hoursStr.includes(dayMap[dayOfWeek] + "ÂÖ¨‰ºë") || hoursStr.includes(dayMap[dayOfWeek] + "‰ºëÊÅØ")) return false;
            if (hoursStr.toUpperCase().includes('24H') || hoursStr.includes('24Â∞èÊôÇ')) return true;
            const timeMatches = cleanStr.match(/(\d{1,2}:\d{2})/g); 
            if (!timeMatches || !Array.isArray(timeMatches) || timeMatches.length < 2) return false;
            let isOpen = false;
            for (let i = 0; i < timeMatches.length - 1; i += 2) {
                const startStr = timeMatches[i]; const endStr = timeMatches[i+1];
                if (!startStr || !endStr) continue;
                const start = parseTime(startStr); const end = parseTime(endStr);
                if (end < start) { if (currentMinutes >= start || currentMinutes <= end) isOpen = true; } 
                else { if (currentMinutes >= start && currentMinutes <= end) isOpen = true; }
            }
            return isOpen;
        }
    </script>
</body>
</html>
