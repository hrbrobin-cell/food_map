<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°ç¾é£Ÿåœ°åœ– (v27.0 ä¿®æ­£ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f6; margin: 0; padding: 15px; color: #222; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #2c3e50; font-size: 2.2em; font-weight: 900; }
        .loading-bar { width: 100%; background: #e2e8f0; height: 4px; position: fixed; top: 0; left: 0; z-index: 9999; display: none; }
        .loading-bar .bar { height: 100%; background: #bd2333; animation: load 1.5s infinite ease-in-out; width: 50%; }
        @keyframes load { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
        .controls-wrapper { max-width: 950px; margin: 0 auto 20px auto; }
        .controls-row-1 { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 12px; }
        .search-box { flex: 2; padding: 12px 20px; border: 2px solid #ccc; border-radius: 30px; font-size: 16px; outline: none; }
        .select-pill { min-width: 140px; padding: 0 15px; border: 2px solid #ccc; border-radius: 30px; height: 48px; font-size: 15px; font-weight: bold; background: white; }
        .select-michelin { border: 2px solid #bd2333; color: #bd2333; background: #fff5f5; }
        .toggle-wrapper { display: flex; align-items: center; background: white; border: 2px solid #ccc; padding: 5px 15px 5px 5px; border-radius: 30px; height: 48px; cursor: pointer; }
        .toggle-switch { position: relative; width: 40px; height: 24px; margin-right: 8px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 34px; transition: .3s; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .3s; }
        input:checked + .slider { background: #38b2ac; }
        input:checked + .slider:before { transform: translateX(16px); }
        .toggle-label { font-size: 15px; font-weight: bold; color: #555; }
        input:checked ~ .toggle-label { color: #38b2ac; }
        .controls-row-2 { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .btn-pill { padding: 0 20px; height: 48px; border-radius: 30px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 6px; border: none; font-size: 15px; cursor: pointer; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-fav { border: 2px solid #e53e3e; color: #e53e3e; } .btn-fav.active { background: #e53e3e; color: white; }
        .btn-gps { border: 2px solid #38b2ac; color: #38b2ac; } .btn-gps.active { background: #38b2ac; color: white; }
        .btn-view { background: #2d3748; color: white; }
        .btn-reset { background: #718096; color: white; }
        .food-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; }
        .food-card { background: white; border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); overflow: hidden; position: relative; }
        .card-image-box { height: 200px; background: #f0f0f0; position: relative; }
        .card-image-box img { width: 100%; height: 100%; object-fit: cover; }
        .card-content { padding: 20px; }
        .card-title { font-size: 1.6em; font-weight: 800; margin: 5px 0 15px 0; color: #1a202c; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .status-badge { font-size: 14px; padding: 5px 12px; border-radius: 20px; font-weight: 800; margin-left: auto; }
        .status-open { background: #c6f6d5; color: #22543d; } .status-closed { background: #edf2f7; color: #718096; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-nav { flex-grow: 1; height: 44px; background: #38b2ac; color: white; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-weight: bold; }
        .btn-booking { flex-grow: 1; height: 44px; background: #ed8936; color: white; border-radius: 8px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-weight: bold; }
        .btn-icon { width: 44px; height: 44px; border-radius: 8px; display: flex; justify-content: center; align-items: center; color: white; font-size: 1.3em; }
        .bg-web { color: #ed8936; } .bg-fb { color: #1877F2; } .bg-ig { color: #d6249f; } .bg-yt { color: #FF0000; }
        .michelin-badge { position: absolute; top: 10px; left: 10px; background: #bd2333; color: white; padding: 5px 12px; border-radius: 4px; font-weight: bold; font-size: 13px; z-index: 5; display: flex; gap: 5px; }
        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 5; }
        .action-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.4); color: white; border: none; cursor: pointer; font-size: 1.2em; backdrop-filter: blur(4px); }
        .action-btn.is-fav { background: white; color: #ff4757; }
        .info-row { display: flex; align-items: flex-start; margin-bottom: 8px; color: #444; line-height: 1.5; }
        .info-icon { margin-right: 10px; color: #38b2ac; margin-top: 4px; }
        #mapContainer { display: none; width: 100%; height: 75vh; border-radius: 16px; margin-top: 20px; }
        #loadMoreBtn { display: none; width: 100%; padding: 15px; margin: 20px 0; background: white; border: 2px solid #38b2ac; color: #38b2ac; font-weight: bold; border-radius: 12px; cursor: pointer; }
        #toast { visibility: hidden; min-width: 250px; background: #333; color: #fff; text-align: center; border-radius: 30px; padding: 16px; position: fixed; bottom: 30px; left: 50%; margin-left: -125px; z-index: 9999; }
        #toast.show { visibility: visible; opacity: 1; transition: opacity 0.5s; }
        #backToTop { position: fixed; bottom: 85px; right: 20px; width: 45px; height: 45px; background: #2c3e50; color: white; border-radius: 50%; border: none; font-size: 1.2em; display: none; align-items: center; justify-content: center; cursor: pointer; }
        
        .filter-section { text-align: center; margin-bottom: 20px; }
        .btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .label { display: block; margin-bottom: 8px; font-weight: bold; color: #666; }
        .city-btn, .district-btn, .type-btn { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-size: 14px; background: #e2e8f0; }
        .city-btn.active { background: #2d3748; color: white; }
        .district-btn.active { background: #38b2ac; color: white; }
        .type-btn { background: white; border: 1px solid #ccc; } .type-btn.active { background: #4a5568; color: white; }
    </style>
</head>
<body>

    <div id="loadingBar" class="loading-bar"><div class="bar"></div></div>

    <header>
        <h1>ğŸ‡¹ğŸ‡¼ å…¨å°ç¾é£Ÿåœ°åœ–</h1>
        <p class="subtitle">v27.0 (ç©©å®šä¿®æ­£ç‰ˆ)</p>
        
        <div class="controls-wrapper">
            <div class="controls-row-1">
                <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹...">
                <select id="michelinSelect" class="select-pill select-michelin" onchange="applyFiltersAndSort()">
                    <option value="all">â­• ä¸é™ç­‰ç´š</option>
                    <option value="any">âœ¨ æ‰€æœ‰ç±³å…¶æ—</option>
                    <option value="3">â­â­â­ ä¸‰æ˜Ÿ</option>
                    <option value="2">â­â­ äºŒæ˜Ÿ</option>
                    <option value="1">â­ ä¸€æ˜Ÿ</option>
                    <option value="bib">ğŸ˜‹ å¿…æ¯”ç™»æ¨è–¦</option>
                    <option value="selected">ğŸ½ï¸ å…¥é¸é¤å»³</option>
                </select>
                <label class="toggle-wrapper">
                    <div class="toggle-switch"><input type="checkbox" id="openFilter" onchange="toggleOpenFilter()"><span class="slider"></span></div>
                    <span class="toggle-label">ç‡Ÿæ¥­ä¸­</span>
                </label>
                <button class="btn-pill btn-reset" onclick="resetAllFilters()"><i class="fas fa-undo"></i> é‡ç½®</button>
            </div>
            <div class="controls-row-2">
                <select id="rangeSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="99999">ğŸ“ è·é›¢: å…¨éƒ¨</option>
                    <option value="1">1 å…¬é‡Œå…§</option>
                    <option value="5" selected>5 å…¬é‡Œå…§</option>
                </select>
                <select id="sortSelect" class="select-pill" onchange="applyFiltersAndSort()">
                    <option value="dist" selected>ğŸ“ è·é›¢è¿‘â†’é </option>
                    <option value="rating">â­ è©•åˆ†é«˜â†’ä½</option>
                </select>
                <button id="gpsBtn" class="btn-pill btn-gps" onclick="findNearby()"><i class="fas fa-location-arrow"></i> é™„è¿‘</button>
                <button id="favFilterBtn" class="btn-pill btn-fav" onclick="toggleFavFilter()">â¤ï¸ å£è¢‹</button>
                <button id="viewBtn" class="btn-pill btn-view" onclick="toggleViewMode()"><i class="fas fa-map-marked-alt"></i> åœ°åœ–</button>
            </div>
        </div>
    </header>

    <div id="loadingMsg" class="loading" style="text-align:center;padding:20px;font-weight:bold;color:#38b2ac;"></div>
    
    <div class="filter-section">
        <span class="label">1. é¸æ“‡ç¸£å¸‚</span><div id="cityButtons" class="btn-container"></div>
        <div id="districtSection" style="display:none;"><span class="label">2. é¸æ“‡åœ°å€</span><div id="districtButtons" class="btn-container"></div></div>
        <span class="label">3. ç¾é£Ÿé¡åˆ¥</span><div id="typeButtons" class="btn-container"></div>
    </div>
    
    <div class="food-list" id="foodContainer"></div>
    <div style="text-align:center;"><button id="loadMoreBtn" onclick="loadMore()">ğŸ‘‡ è¼‰å…¥æ›´å¤š</button></div>
    <div id="mapContainer"></div>
    <div id="toast"></div>
    <button id="backToTop" onclick="scrollToTop()"><i class="fas fa-arrow-up"></i></button>

    <script>
        // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ GAS éƒ¨ç½²ç¶²å€
        const scriptUrl = 'YOUR_GAS_SCRIPT_URL_HERE';
        const sheetID = '2PACX-1vRJXAD8XnJT4MfBoaSSCpByuNcUVwlXTCL702vtUBDsg8aZ__v-_yxXVRVQntuqaJY3eecAwq7qZDIb';
        const rawUrl = `https://docs.google.com/spreadsheets/d/e/${sheetID}/pub?output=csv&cache_bust=${Date.now()}`;
        const proxyList = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url=', 'https://api.codetabs.com/v1/proxy?quest='];

        let appState = { allData: [], currentCity: "å…¨å°", currentDistrict: "å…¨éƒ¨", currentType: "å…¨éƒ¨", currentKeyword: "", isShowingFavs: false, isShowingNearby: false, isOpenOnly: false, myFavorites: [], viewMode: 'list', displayedCount: 0, filteredData: [] };
        const BATCH_SIZE = 30;
        let map = null, markersGroup = null;

        try { appState.myFavorites = JSON.parse(localStorage.getItem('myFoodFavorites')) || []; } catch (e) {}

        init();

        function init() {
            document.getElementById('searchInput').value = "";
            document.getElementById('michelinSelect').value = "all";
            document.getElementById('openFilter').checked = false;
            
            window.onscroll = () => document.getElementById('backToTop').style.display = (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) ? "flex" : "none";

            const cachedData = localStorage.getItem('foodMapData');
            const cachedTime = localStorage.getItem('foodMapData_ts');
            
            if (cachedData && cachedTime && (Date.now() - cachedTime < 3600000)) {
                processData(JSON.parse(cachedData), true);
                fetchDataSmart(true);
            } else {
                document.getElementById('loadingMsg').innerText = "â³ æ­£åœ¨ä¸‹è¼‰è³‡æ–™...";
                document.getElementById('loadingBar').style.display = 'block';
                fetchDataSmart(false);
            }
            
            document.getElementById('searchInput').addEventListener('input', (e) => {
                setTimeout(() => { appState.currentKeyword = e.target.value.toLowerCase(); appState.isShowingFavs = false; applyFiltersAndSort(); }, 300);
            });
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        function fetchDataSmart(isBackground) {
            const apiPromise = new Promise((resolve, reject) => {
                if (scriptUrl && scriptUrl.includes('script.google.com') && !scriptUrl.includes('YOUR_GAS')) {
                    fetch(scriptUrl).then(r => r.json()).then(data => resolve(data)).catch(e => reject(e));
                } else reject("No API");
            });
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 3000));

            Promise.race([apiPromise, timeoutPromise])
                .then(data => {
                    localStorage.setItem('foodMapData', JSON.stringify(data));
                    localStorage.setItem('foodMapData_ts', Date.now());
                    processData(data, true);
                    document.getElementById('loadingBar').style.display = 'none';
                    document.getElementById('loadingMsg').style.display = 'none';
                })
                .catch(() => tryFetchCSV(0, isBackground));
        }

        function tryFetchCSV(idx, bg) {
            if (idx >= proxyList.length) { if(!bg) document.getElementById('loadingMsg').innerHTML = "âš ï¸ é€£ç·šå¤±æ•—"; return; }
            Papa.parse(proxyList[idx] + encodeURIComponent(rawUrl), {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    localStorage.setItem('foodMapData', JSON.stringify(results.data));
                    localStorage.setItem('foodMapData_ts', Date.now());
                    processData(results.data, true);
                    document.getElementById('loadingBar').style.display = 'none';
                    document.getElementById('loadingMsg').style.display = 'none';
                },
                error: () => tryFetchCSV(idx + 1, bg)
            });
        }

        function processData(data, refreshUI) {
            appState.allData = data.filter(item => item.name).map(item => {
                const n = {};
                Object.keys(item).forEach(k => n[k ? k.toLowerCase().trim() : ""] = item[k] || "");
                if(!n.city) n.city = "æœªåˆ†é¡";
                n.id = `${n.city}-${n.name}`;
                n.lat = parseFloat(n.lat); n.lng = parseFloat(n.lng);
                n.rating = parseFloat(n.rating || 0);
                n.michelinType = n.michelin ? n.michelin.toString().toLowerCase() : "";
                if (n.hours) n.parsedSchedule = parseStandardSchedule(n.hours);
                return n;
            });
            if(refreshUI) { renderCityButtons(); renderTypeButtons(); applyFiltersAndSort(); }
        }

        // --- å‰ç«¯è§£æå™¨ï¼šè™•ç† v11.0 å‚³ä¾†çš„ "12:00-14:30 (é€±å…­,é€±æ—¥); ..." ---
        function parseStandardSchedule(str) {
            let schedule = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]};
            const map = {'æ—¥':0, 'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6};
            const allDays = [0,1,2,3,4,5,6];
            
            let parts = str.split(';');
            let closedDays = [];
            
            parts.forEach(p => {
                if (p.includes("å…¬ä¼‘")) {
                    for(let k in map) if(p.includes("é€±"+k)) closedDays.push(map[k]);
                }
            });

            parts.forEach(p => {
                if (p.includes("å…¬ä¼‘")) return; 
                // é€™è£¡è¦æ”¯æ´å¤šæ™‚æ®µ "12:00-14:00, 18:00-21:00"
                // å…ˆæŠŠæ—¥æœŸéƒ¨åˆ†åˆ†é›¢
                let dayPart = p.match(/\((.*?)\)/);
                let timeStr = p;
                let specificDays = [];

                if (dayPart) {
                    timeStr = p.replace(dayPart[0], ""); // ç§»é™¤æ—¥æœŸæ‹¬è™Ÿ
                    let dStr = dayPart[1];
                    dStr.replace(/é€±([æ—¥ä¸€äºŒä¸‰å››äº”å…­])\s*[-]\s*é€±([æ—¥ä¸€äºŒä¸‰å››äº”å…­])/g, (m, d1, d2) => {
                        let s = map[d1], e = map[d2];
                        if (e < s) e += 7;
                        for(let i=s; i<=e; i++) specificDays.push(i%7);
                        return "";
                    });
                    for(let k in map) if(dStr.includes("é€±"+k)) specificDays.push(map[k]);
                } else {
                    specificDays = allDays;
                }

                // æŠ“å–æ‰€æœ‰æ™‚é–“ (å«é€—è™Ÿåˆ†éš”)
                let times = timeStr.match(/(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/g);
                if (times) {
                    specificDays.forEach(d => {
                        if (!closedDays.includes(d)) {
                            times.forEach(t => {
                                let [s, e] = t.split('-');
                                let start = parseTime(s), end = parseTime(e);
                                if (end < start) end += 1440;
                                schedule[d].push([start, end]);
                            });
                        }
                    });
                }
            });
            return schedule;
        }

        function parseTime(t) {
            let p = t.split(':');
            return parseInt(p[0]) * 60 + parseInt(p[1]);
        }

        function checkIsOpen(parsedSchedule) {
            if (!parsedSchedule) return false;
            const now = new Date();
            const d = now.getDay();
            const m = now.getHours() * 60 + now.getMinutes();
            
            const ranges = parsedSchedule[d];
            if (!ranges || ranges.length === 0) return false;

            for (let i = 0; i < ranges.length; i++) {
                const [s, e] = ranges[i];
                let check = m;
                if (check < s && e >= 1440) check += 1440;
                if (check >= s && check <= e) return true;
            }
            return false;
        }

        function applyFiltersAndSort() {
            let res = [...appState.allData];
            if (appState.isShowingFavs) res = res.filter(i => appState.myFavorites.includes(i.id));
            else {
                if (appState.currentKeyword) res = res.filter(i => i.name.toLowerCase().includes(appState.currentKeyword));
                else {
                    if (appState.currentCity !== "å…¨å°") {
                        res = res.filter(i => i.city === appState.currentCity);
                        if (appState.currentDistrict !== "å…¨éƒ¨") res = res.filter(i => i.district === appState.currentDistrict);
                    }
                }
                if (appState.currentType !== "å…¨éƒ¨") res = res.filter(i => i.type === appState.currentType);
            }

            if (appState.isOpenOnly) res = res.filter(i => checkIsOpen(i.parsedSchedule));

            const mode = document.getElementById('michelinSelect').value;
            if (mode !== 'all') {
                if (mode === 'any') res = res.filter(i => i.michelinType !== "");
                else res = res.filter(i => i.michelinType === mode);
            }

            if (appState.isShowingNearby) {
                const limit = parseFloat(document.getElementById('rangeSelect').value);
                res = res.filter(i => i.distance <= limit);
            }

            const sort = document.getElementById('sortSelect').value;
            res.sort((a, b) => sort === 'rating' ? b.rating - a.rating : a.distance - b.distance);

            appState.filteredData = res;
            appState.displayedCount = 0;
            document.getElementById('foodContainer').innerHTML = '';
            
            if (appState.viewMode === 'list') loadMore(); else renderMap(res);
        }

        function loadMore() {
            const container = document.getElementById('foodContainer');
            const total = appState.filteredData.length;
            const start = appState.displayedCount;
            const end = Math.min(start + BATCH_SIZE, total);
            
            if (start >= total) {
                if (total === 0) container.innerHTML = '<p style="text-align:center;padding:40px;">æ²’æœ‰ç¬¦åˆçš„åº—å®¶</p>';
                document.getElementById('loadMoreBtn').style.display = 'none';
                return;
            }

            const frag = document.createDocumentFragment();
            for (let i = start; i < end; i++) frag.appendChild(createCard(appState.filteredData[i]));
            container.appendChild(frag);
            appState.displayedCount = end;
            
            document.getElementById('loadMoreBtn').style.display = (end < total) ? 'inline-block' : 'none';
        }

        function createCard(item) {
            const isOpen = checkIsOpen(item.parsedSchedule);
            const statusHtml = isOpen ? '<span class="status-badge status-open">ğŸŸ¢ ç‡Ÿæ¥­ä¸­</span>' : '<span class="status-badge status-closed">âšª ä¼‘æ¯ä¸­</span>';
            const michelin = getMichelinBadge(item.michelinType);
            const isFav = appState.myFavorites.includes(item.id) ? 'is-fav' : '';
            let btns = '';
            if (item.booking) btns += `<a href="${item.booking}" target="_blank" class="btn-booking">ğŸ“… è¨‚ä½</a>`;
            btns += `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name)}" target="_blank" class="btn-nav">ğŸ“ å°èˆª</a>`;
            if(item.website) btns += `<a href="${item.website}" class="btn-icon bg-web"><i class="fas fa-globe"></i></a>`;
            
            const div = document.createElement('div');
            div.className = 'food-card';
            div.innerHTML = `
                <div class="card-image-box">
                    ${michelin}
                    ${item.image ? `<img src="${item.image}" loading="lazy">` : `<div class="card-placeholder" style="background:#ddd"><i class="fas fa-utensils"></i></div>`}
                    <div class="card-actions">
                        <button class="action-btn share-btn" onclick="shareStore('${item.name}')"><i class="fas fa-share-alt"></i></button>
                        <button class="action-btn btn-love ${isFav}" onclick="toggleHeart('${item.id}', this)"><i class="fas fa-heart"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="card-top-row">
                        <div class="meta-group"><span class="meta-tag">${item.city}</span><span class="meta-tag">${item.type}</span></div>
                        ${statusHtml}
                    </div>
                    <h3 class="card-title">${item.name} <span class="rating-badge">â­ ${item.rating}</span></h3>
                    <div class="info-row"><i class="far fa-clock info-icon"></i><span>${item.hours}</span></div>
                    <div class="info-row"><i class="fas fa-phone-alt info-icon"></i><span>${item.phone||"ç„¡"}</span></div>
                    <div class="info-row"><i class="fas fa-map-marker-alt info-icon"></i><span>${item.address}</span></div>
                    <div class="btn-group">${btns}</div>
                </div>
            `;
            return div;
        }

        // è¼”åŠ©å‡½å¼
        function getMichelinBadge(t) { if(!t)return""; const map={'3':'â­â­â­','2':'â­â­','1':'â­','bib':'ğŸ˜‹ å¿…æ¯”ç™»','selected':'ğŸ½ï¸ å…¥é¸'}; return `<div class="michelin-badge">${map[t]||''}</div>`; }
        function resetAllFilters() { 
            appState = { ...appState, isShowingFavs:false, isShowingNearby:false, isOpenOnly:false, currentKeyword:"", currentType:"å…¨éƒ¨", currentCity:"å…¨å°", currentDistrict:"å…¨éƒ¨" };
            document.getElementById('searchInput').value = "";
            document.getElementById('michelinSelect').value = "all";
            document.getElementById('openFilter').checked = false;
            document.getElementById('rangeSelect').value = "99999";
            updateUIState(); renderTypeButtons(); renderCityButtons(); applyFiltersAndSort();
            showToast("ğŸ”„ å·²é‡ç½®");
        }
        function renderCityButtons() { 
            const cities = ["å…¨å°", ...new Set(appState.allData.map(i=>i.city))];
            const div = document.getElementById('cityButtons'); div.innerHTML = "";
            cities.forEach(c => {
                const b = document.createElement('button'); b.className = `city-btn ${c===appState.currentCity?'active':''}`; b.innerText = c;
                b.onclick = () => { appState.currentCity = c; appState.currentDistrict = "å…¨éƒ¨"; document.getElementById('districtSection').style.display = c==="å…¨å°"?'none':'block'; renderCityButtons(); applyFiltersAndSort(); };
                div.appendChild(b);
            });
        }
        function renderTypeButtons() { const types = ["å…¨éƒ¨", ...new Set(appState.allData.map(i => i.type).filter(t => t))]; const container = document.getElementById('typeButtons'); container.innerHTML = ''; types.forEach(type => { const btn = document.createElement('button'); btn.className = `type-btn ${type===appState.currentType?'active':''}`; btn.innerText = type; btn.onclick = () => { appState.currentType = type; renderTypeButtons(); applyFiltersAndSort(); }; container.appendChild(btn); }); }
        function toggleFavFilter() { appState.isShowingFavs = !appState.isShowingFavs; appState.isShowingNearby = false; updateUIState(); applyFiltersAndSort(); }
        function toggleHeart(id, btn) { const idx = appState.myFavorites.indexOf(id); if(idx===-1) { appState.myFavorites.push(id); btn.classList.add('is-fav'); } else { appState.myFavorites.splice(idx,1); btn.classList.remove('is-fav'); if(appState.isShowingFavs) applyFiltersAndSort(); } localStorage.setItem('myFoodFavorites', JSON.stringify(appState.myFavorites)); }
        function findNearby() { appState.isShowingNearby = true; appState.isShowingFavs = false; appState.currentCity = "å…¨å°"; updateUIState(); navigator.geolocation.getCurrentPosition(p => { appState.allData.forEach(i => i.distance = calcDist(p.coords.latitude, p.coords.longitude, i.lat, i.lng)); document.getElementById('sortSelect').value = 'dist'; applyFiltersAndSort(); }); }
        function calcDist(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180; const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); }
        function formatDistance(km) { if (km >= 9999) return ""; if (km < 1) return (km * 1000).toFixed(0) + " m"; return km.toFixed(1) + " km"; }
        function toggleViewMode() { appState.viewMode = appState.viewMode==='list'?'map':'list'; document.getElementById('viewBtn').innerHTML = appState.viewMode==='list'?'<i class="fas fa-map-marked-alt"></i> åœ°åœ–':'<i class="fas fa-list"></i> åˆ—è¡¨'; document.getElementById('foodContainer').style.display = appState.viewMode==='list'?'grid':'none'; document.getElementById('mapContainer').style.display = appState.viewMode==='map'?'block':'none'; document.getElementById('loadMoreBtn').style.display = appState.viewMode==='list'?'inline-block':'none'; if(appState.viewMode==='map') setTimeout(() => { if(!map) initMap(); map.invalidateSize(); applyFiltersAndSort(); }, 100); }
        function updateUIState() { const gpsBtn = document.getElementById('gpsBtn'); const favBtn = document.getElementById('favFilterBtn'); if (appState.isShowingFavs) { favBtn.classList.add('active'); favBtn.innerText = "ğŸ”™ å›åˆ—è¡¨"; } else { favBtn.classList.remove('active'); favBtn.innerText = "â¤ï¸ å£è¢‹"; } if (appState.isShowingNearby) { gpsBtn.classList.add('active'); document.getElementById('cityButtons').style.display = 'none'; } else { gpsBtn.classList.remove('active'); document.getElementById('cityButtons').style.display = 'flex'; } renderCityButtons(); }
        function initMap() { if (map) return; map = L.map('mapContainer').setView([23.9738, 120.9820], 7); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map); markersGroup = L.markerClusterGroup().addTo(map); }
        function renderMap(data) { if (!map) initMap(); markersGroup.clearLayers(); const valid = data.filter(d => d.lat && d.lng); if (valid.length === 0) return; const bounds = []; valid.forEach(i => { const m = L.marker([i.lat, i.lng]); m.bindPopup(createCard(i).outerHTML); markersGroup.addLayer(m); bounds.push([i.lat, i.lng]); }); if (bounds.length) map.fitBounds(bounds); }
        function shareStore(name) { if(navigator.share) navigator.share({title:name, text:name, url:window.location.href}); else showToast("å·²è¤‡è£½é€£çµ"); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText=m; t.className="show"; setTimeout(()=>t.className="", 3000); }
        function toggleOpenFilter() { appState.isOpenOnly = document.getElementById('openFilter').checked; applyFiltersAndSort(); }
    </script>
</body>
</html>
